<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlow - Web IPTV Player</title>
    
    <!-- Meta Tags para SEO e Redes Sociais (Essencial para Vercel/Produção) -->
    <meta name="description" content="Assista TV ao vivo, Filmes e Séries diretamente no seu navegador. Player IPTV moderno, rápido e gratuito.">
    <meta name="theme-color" content="#0f172a">
    
    <!-- Open Graph / Facebook / WhatsApp -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://streamflow.vercel.app/">
    <meta property="og:title" content="StreamFlow - Web IPTV Player">
    <meta property="og:description" content="Player IPTV web moderno com suporte a HLS, favoritos e organização automática de canais.">
    <meta property="og:image" content="https://images.unsplash.com/photo-1593784991095-a20506948430?q=80&w=1200&auto=format&fit=crop">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="StreamFlow - Web IPTV Player">
    <meta property="twitter:description" content="Assista TV ao vivo, Filmes e Séries. Player M3U via Web.">
    <meta property="twitter:image" content="https://images.unsplash.com/photo-1593784991095-a20506948430?q=80&w=1200&auto=format&fit=crop">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HLS.js para reprodução de streams .m3u8 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            500: '#6366f1', // Indigo
                            600: '#4f46e5',
                        },
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        /* Efeito de Vidro */
        .glass {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-dark-900 text-gray-100 font-sans antialiased overflow-hidden h-screen flex flex-col">

    <!-- Modal de Carregamento de Lista -->
    <div id="setupModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-dark-800 p-8 rounded-2xl shadow-2xl w-full max-w-2xl border border-dark-700 m-4">
            <div class="text-center mb-8">
                <div class="flex justify-center mb-4 text-brand-500">
                    <i class="ph ph-television-simple text-6xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Bem-vindo ao StreamFlow</h1>
                <p class="text-gray-400">Carregue sua lista M3U para começar a assistir</p>
            </div>

            <div class="space-y-6">
                <!-- Tabs -->
                <div class="flex border-b border-dark-700">
                    <button onclick="switchTab('file')" id="tab-file" class="flex-1 pb-4 text-brand-500 border-b-2 border-brand-500 font-medium transition">Arquivo .M3U</button>
                    <button onclick="switchTab('url')" id="tab-url" class="flex-1 pb-4 text-gray-400 hover:text-white font-medium transition">URL Remota</button>
                    <button onclick="switchTab('sample')" id="tab-sample" class="flex-1 pb-4 text-gray-400 hover:text-white font-medium transition">Teste Grátis</button>
                </div>

                <!-- Tab Contents -->
                <div id="content-file" class="tab-content block">
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-dark-700 rounded-lg cursor-pointer hover:bg-dark-700/50 transition bg-dark-800">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i class="ph ph-upload-simple text-3xl mb-2 text-gray-400"></i>
                            <p class="mb-2 text-sm text-gray-400"><span class="font-semibold">Clique para enviar</span> ou arraste</p>
                            <p class="text-xs text-gray-500">Suporta .m3u e .m3u8</p>
                        </div>
                        <input id="fileInput" type="file" class="hidden" accept=".m3u,.m3u8,.txt" />
                    </label>
                </div>

                <div id="content-url" class="tab-content hidden">
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400">Cole a URL da sua lista</label>
                        <div class="flex gap-2">
                            <input id="urlInput" type="text" placeholder="https://exemplo.com/lista.m3u" class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-3 focus:outline-none focus:border-brand-500 transition text-white">
                            <button onclick="loadFromUrl()" class="bg-brand-600 hover:bg-brand-500 text-white px-6 py-2 rounded-lg font-medium transition flex items-center gap-2">
                                <i class="ph ph-arrow-right"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2"><i class="ph ph-info"></i> Se falhar, tentaremos usar um proxy automaticamente.</p>
                    </div>
                </div>

                <div id="content-sample" class="tab-content hidden text-center py-4">
                    <p class="text-gray-400 mb-4">Carregue uma lista pública de demonstração (Samsung TV Plus / canais abertos).</p>
                    <button onclick="loadSample()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-lg font-medium transition shadow-lg shadow-green-900/20 w-full sm:w-auto">
                        Carregar Lista Demo (Brasil)
                    </button>
                </div>
                
                <div id="loadingState" class="hidden flex flex-col items-center justify-center py-4">
                    <div class="loader mb-3"></div>
                    <p id="loadingText" class="text-sm text-gray-400">Processando canais...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Layout Principal -->
    <div class="flex h-full">
        
        <!-- Sidebar -->
        <aside class="hidden lg:flex w-64 bg-dark-800 border-r border-dark-700 flex-col transition-all duration-300 z-20" id="sidebar">
            <div class="h-16 flex items-center px-6 border-b border-dark-700 shrink-0">
                <i class="ph ph-play-circle text-3xl text-brand-500"></i>
                <span class="ml-3 font-bold text-xl tracking-wide">StreamFlow</span>
            </div>

            <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-2 custom-scroll">
                <button onclick="filterCategory('all')" class="nav-item w-full flex items-center p-3 rounded-lg bg-brand-600/10 text-brand-500">
                    <i class="ph ph-squares-four text-xl"></i>
                    <span class="ml-3">Todos</span>
                </button>
                <button onclick="filterCategory('favorites')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:bg-dark-700 hover:text-white transition">
                    <i class="ph ph-heart text-xl"></i>
                    <span class="ml-3">Favoritos</span>
                </button>
                <div class="my-4 border-t border-dark-700 mx-2"></div>
                <button onclick="filterCategory('live')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:bg-dark-700 hover:text-white transition">
                    <i class="ph ph-television text-xl"></i>
                    <span class="ml-3">TV Ao Vivo</span>
                </button>
                <button onclick="filterCategory('movies')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:bg-dark-700 hover:text-white transition">
                    <i class="ph ph-film-strip text-xl"></i>
                    <span class="ml-3">Filmes</span>
                </button>
                <button onclick="filterCategory('series')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:bg-dark-700 hover:text-white transition">
                    <i class="ph ph-cards text-xl"></i>
                    <span class="ml-3">Séries</span>
                </button>
                
                <div class="mt-6 px-3 mb-2 text-xs font-bold text-gray-500 uppercase tracking-wider">Grupos</div>
                <div id="groupList" class="space-y-1 pb-4">
                    <!-- Grupos dinâmicos aqui -->
                </div>
            </nav>

            <div class="p-4 border-t border-dark-700 shrink-0">
                <button onclick="resetApp()" class="flex items-center w-full text-red-400 hover:text-red-300 transition p-2 rounded hover:bg-red-400/10">
                    <i class="ph ph-sign-out text-xl"></i>
                    <span class="ml-3 text-sm font-medium">Trocar Lista</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-dark-900 relative min-w-0">
            
            <!-- Mobile Header -->
            <div class="lg:hidden h-16 bg-dark-800 border-b border-dark-700 flex items-center justify-between px-4 shrink-0">
                 <div class="flex items-center">
                    <i class="ph ph-play-circle text-2xl text-brand-500"></i>
                    <span class="ml-2 font-bold text-lg">StreamFlow</span>
                </div>
                <button onclick="document.getElementById('mobileMenu').classList.toggle('hidden')" class="text-white p-2">
                    <i class="ph ph-list text-2xl"></i>
                </button>
            </div>

            <!-- Mobile Menu Dropdown -->
            <div id="mobileMenu" class="hidden lg:hidden bg-dark-800 border-b border-dark-700 absolute top-16 left-0 right-0 z-30 p-4 shadow-xl">
                 <div class="grid grid-cols-2 gap-2">
                    <button onclick="filterCategory('all'); toggleMobileMenu()" class="p-2 bg-dark-700 rounded text-center text-sm">Todos</button>
                    <button onclick="filterCategory('favorites'); toggleMobileMenu()" class="p-2 bg-dark-700 rounded text-center text-sm">Favoritos</button>
                    <button onclick="filterCategory('live'); toggleMobileMenu()" class="p-2 bg-dark-700 rounded text-center text-sm">TV</button>
                    <button onclick="filterCategory('movies'); toggleMobileMenu()" class="p-2 bg-dark-700 rounded text-center text-sm">Filmes</button>
                 </div>
                 <button onclick="resetApp()" class="w-full mt-4 p-2 bg-red-900/30 text-red-400 rounded text-sm">Sair da Lista</button>
            </div>
            
            <!-- Search & Info Bar -->
            <header class="h-16 glass flex items-center justify-between px-4 lg:px-8 z-10 sticky top-0 shrink-0">
                <div class="flex items-center bg-dark-900/50 rounded-full px-4 py-2 w-full max-w-md border border-dark-700 focus-within:border-brand-500 transition">
                    <i class="ph ph-magnifying-glass text-gray-400 text-lg"></i>
                    <input id="searchInput" type="text" placeholder="Buscar canal..." class="bg-transparent border-none focus:outline-none text-white ml-3 w-full placeholder-gray-500">
                </div>
                
                <div class="flex items-center gap-4 ml-4">
                    <div class="text-right hidden sm:block">
                        <p id="channelCount" class="text-xs text-gray-400">0 canais</p>
                        <p class="text-sm font-semibold text-white truncate max-w-[150px]" id="categoryTitle">Todos</p>
                    </div>
                </div>
            </header>

            <!-- Grid de Conteúdo -->
            <div id="scrollContainer" class="flex-1 overflow-y-auto p-4 lg:p-6 custom-scroll">
                <div id="contentGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-4 lg:gap-6 content-start pb-8">
                    <!-- Cards serão injetados via JS -->
                </div>
                
                <!-- Load More Button -->
                <div id="loadMoreContainer" class="hidden w-full flex justify-center py-8">
                    <button onclick="loadMoreChannels()" class="bg-dark-700 hover:bg-dark-600 text-white px-6 py-3 rounded-full font-medium transition flex items-center gap-2 shadow-lg">
                        <i class="ph ph-plus-circle text-xl"></i>
                        Carregar Mais
                    </button>
                </div>

                <div id="emptyState" class="hidden flex flex-col items-center justify-center text-gray-500 py-20">
                    <i class="ph ph-ghost text-6xl mb-4"></i>
                    <p class="text-lg">Nenhum conteúdo encontrado.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Player Overlay -->
    <div id="playerOverlay" class="fixed inset-0 z-[60] bg-black hidden flex flex-col">
        <!-- Header do Player -->
        <div class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/90 to-transparent z-20 flex justify-between items-center opacity-0 hover:opacity-100 transition-opacity duration-300" id="playerControls">
            <div class="flex items-center gap-4">
                <button onclick="closePlayer()" class="text-white hover:text-brand-500 transition p-2 bg-black/40 rounded-full backdrop-blur-md">
                    <i class="ph ph-arrow-left text-2xl"></i>
                </button>
                <div class="text-shadow">
                    <h2 id="playerTitle" class="text-white font-bold text-lg drop-shadow-md">Título do Canal</h2>
                    <p id="playerGroup" class="text-gray-300 text-xs drop-shadow-md">Grupo</p>
                </div>
            </div>
            <div class="flex gap-2">
                 <button onclick="toggleAspectRatio()" class="text-white hover:text-brand-500 transition p-2 bg-black/40 rounded-full backdrop-blur-md" title="Ajustar Tela">
                    <i class="ph ph-frame-corners text-2xl"></i>
                </button>
            </div>
        </div>

        <!-- Video Element -->
        <div class="flex-1 relative flex items-center justify-center bg-black w-full h-full">
            <video id="videoPlayer" class="w-full h-full" controls autoplay playsinline></video>
            
            <!-- Mensagem de Erro -->
            <div id="playerError" class="hidden absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-center p-4 z-10">
                <i class="ph ph-warning-octagon text-5xl text-red-500 mb-4"></i>
                <h3 class="text-xl font-bold text-white mb-2">Erro na Reprodução</h3>
                <p id="errorDetails" class="text-gray-400 mb-6 max-w-md">Não foi possível carregar este canal. Pode estar offline ou bloqueado por CORS.</p>
                <div class="flex gap-4">
                    <button onclick="closePlayer()" class="px-6 py-2 border border-gray-600 text-white rounded hover:bg-gray-800 transition">Voltar</button>
                    <button onclick="retryStream()" class="px-6 py-2 bg-brand-600 text-white rounded hover:bg-brand-500 transition">Tentar Novamente</button>
                </div>
                <p class="text-xs text-gray-600 mt-8">Dica: Se estiver usando HTTPS, streams HTTP podem ser bloqueados.</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- Estado Global ---
        let allChannels = [];
        let filteredChannels = [];
        let favorites = JSON.parse(localStorage.getItem('streamflow_favorites') || '[]');
        let currentCategory = 'all'; 
        let hls = null;
        let renderedCount = 0;
        const BATCH_SIZE = 48; // Quantidade de itens por "página"
        const video = document.getElementById('videoPlayer');

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Listeners
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            
            // Video Listeners
            video.addEventListener('error', (e) => {
                handleVideoError();
            });
        });

        // Função Debounce para otimizar busca
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.add('hidden');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            ['file', 'url', 'sample'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if(t === tabName) {
                    btn.classList.remove('text-gray-400', 'border-transparent');
                    btn.classList.add('text-brand-500', 'border-b-2', 'border-brand-500');
                } else {
                    btn.classList.add('text-gray-400');
                    btn.classList.remove('text-brand-500', 'border-b-2', 'border-brand-500');
                }
            });
        }

        // --- Lógica de Parsing (Melhorada) ---
        function parseM3U(content) {
            const lines = content.split(/\r?\n/);
            const channels = [];
            let currentChannel = { name: '', logo: '', group: 'Geral', url: '' };
            let hasInfo = false;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;

                if (line.startsWith('#EXTINF:')) {
                    hasInfo = true;
                    // Reset canal
                    currentChannel = { name: '', logo: '', group: 'Geral', url: '' };
                    
                    // Extração de metadados
                    const infoData = line.substring(8); // Remove #EXTINF:
                    
                    // Tenta pegar o nome (tudo após a última vírgula)
                    const lastCommaIndex = infoData.lastIndexOf(',');
                    if (lastCommaIndex !== -1) {
                        currentChannel.name = infoData.substring(lastCommaIndex + 1).trim();
                    } else {
                        currentChannel.name = "Canal Sem Nome";
                    }

                    // Tenta extrair logo
                    const logoMatch = line.match(/tvg-logo=["']([^"']*)["']/i);
                    if (logoMatch) currentChannel.logo = logoMatch[1];

                    // Tenta extrair grupo
                    const groupMatch = line.match(/group-title=["']([^"']*)["']/i);
                    if (groupMatch) {
                        currentChannel.group = groupMatch[1];
                    } else {
                        // Tenta inferir grupo se não tiver tag
                        if (currentChannel.name.toUpperCase().includes('FILMES')) currentChannel.group = "Filmes";
                    }
                    
                    // Categorização
                    const groupLower = currentChannel.group.toLowerCase();
                    if (groupLower.includes('movie') || groupLower.includes('filme') || groupLower.includes('cinema') || groupLower.includes('cine')) {
                        currentChannel.type = 'movies';
                    } else if (groupLower.includes('series') || groupLower.includes('série') || groupLower.includes('temporada')) {
                        currentChannel.type = 'series';
                    } else {
                        currentChannel.type = 'live';
                    }

                } else if (line.startsWith('http') || line.startsWith('rtmp') || (line.endsWith('.m3u8') && !line.startsWith('#'))) {
                    // É uma URL
                    currentChannel.url = line;
                    
                    // Se não teve #EXTINF antes (lista simples), usa a URL como nome
                    if (!hasInfo) {
                        currentChannel.name = `Canal ${channels.length + 1}`;
                        currentChannel.type = 'live';
                    }

                    if (currentChannel.name && currentChannel.url) {
                        currentChannel.id = generateId(currentChannel.url);
                        channels.push({ ...currentChannel }); // Clone
                    }
                    hasInfo = false;
                }
            }
            return channels;
        }

        // Gera ID único baseado na URL para persistência de favoritos
        function generateId(url) {
            let hash = 0;
            for (let i = 0; i < url.length; i++) {
                const char = url.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // --- Carregamento ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            setLoading(true, "Lendo arquivo...");
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                processPlaylist(content);
            };
            reader.readAsText(file);
        }

        async function loadFromUrl() {
            let url = document.getElementById('urlInput').value.trim();
            if(!url) return;
            
            setLoading(true, "Baixando lista...");
            
            try {
                // Tentativa 1: Direta
                let response = await fetch(url);
                if (!response.ok) throw new Error('Falha direta');
                let text = await response.text();
                processPlaylist(text);
            } catch (err) {
                console.log("Falha direta, tentando proxy...");
                setLoading(true, "Usando proxy de segurança...");
                
                try {
                    // Tentativa 2: AllOrigins (Proxy JSON)
                    // URL encoded
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    const data = await response.json();
                    if (data.contents) {
                        processPlaylist(data.contents);
                    } else {
                        throw new Error("Proxy vazio");
                    }
                } catch (proxyErr) {
                    alert('Erro ao carregar URL. Tente baixar o arquivo .m3u e usar a aba de upload.\nMotivo: Bloqueio de segurança (CORS) do provedor da lista.');
                    setLoading(false);
                }
            }
        }

        async function loadSample() {
            setLoading(true, "Carregando canais do Brasil...");
            const sampleUrl = 'https://iptv-org.github.io/iptv/countries/br.m3u';
            try {
                const response = await fetch(sampleUrl);
                const text = await response.text();
                processPlaylist(text);
            } catch (err) {
                alert('Erro ao conectar ao servidor de demonstração.');
                setLoading(false);
            }
        }

        function setLoading(active, text = "") {
            const el = document.getElementById('loadingState');
            const txt = document.getElementById('loadingText');
            if (active) {
                el.classList.remove('hidden');
                txt.textContent = text;
            } else {
                el.classList.add('hidden');
            }
        }

        function processPlaylist(content) {
            setLoading(true, "Processando canais...");
            
            // Pequeno delay para UI atualizar
            setTimeout(() => {
                allChannels = parseM3U(content);
                
                if (allChannels.length === 0) {
                    alert('Nenhum canal válido encontrado. Verifique o formato do arquivo.');
                    setLoading(false);
                    return;
                }

                // Ordena alfabeticamente
                allChannels.sort((a, b) => a.name.localeCompare(b.name));

                // Fecha modal
                document.getElementById('setupModal').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    document.getElementById('setupModal').classList.add('hidden');
                }, 300);

                populateGroups();
                filterCategory('all');
                setLoading(false);
            }, 100);
        }

        // --- Renderização ---
        function populateGroups() {
            const groups = [...new Set(allChannels.map(c => c.group))].sort();
            const groupList = document.getElementById('groupList');
            groupList.innerHTML = '';
            
            groups.forEach(group => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left px-3 py-2 text-sm text-gray-400 hover:text-white hover:bg-dark-700 rounded truncate transition';
                btn.textContent = group;
                btn.onclick = () => {
                    filterByGroup(group);
                    // Mobile: close menu if open (lógica simplificada)
                };
                groupList.appendChild(btn);
            });
        }

        function renderChannels(channels, append = false) {
            const grid = document.getElementById('contentGrid');
            const empty = document.getElementById('emptyState');
            const loadMoreBtn = document.getElementById('loadMoreContainer');
            const countEl = document.getElementById('channelCount');
            
            if (!append) {
                grid.innerHTML = '';
                renderedCount = 0;
                // Scroll para o topo
                document.getElementById('scrollContainer').scrollTop = 0;
            }

            countEl.innerText = `${channels.length} canais`;

            if (channels.length === 0) {
                empty.classList.remove('hidden');
                loadMoreBtn.classList.add('hidden');
                return;
            }
            empty.classList.add('hidden');

            // Paginação
            const nextBatch = channels.slice(renderedCount, renderedCount + BATCH_SIZE);
            
            nextBatch.forEach(channel => {
                const isFav = favorites.includes(channel.id);
                
                const card = document.createElement('div');
                card.className = 'group relative bg-dark-800 rounded-lg overflow-hidden cursor-pointer card-hover transition-all duration-300 aspect-video flex flex-col border border-dark-700';
                card.onclick = (e) => {
                    if(!e.target.closest('.fav-btn')) openPlayer(channel);
                };

                // Logo Fallback Inteligente
                let logoUrl = channel.logo;
                if (!logoUrl || logoUrl.length < 5) {
                    // Avatar gerado com iniciais
                    const initials = channel.name.substring(0,2).toUpperCase();
                    logoUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=1e293b&color=6366f1&size=256&font-size=0.4&bold=true`;
                }

                card.innerHTML = `
                    <div class="relative flex-1 bg-black w-full overflow-hidden">
                        <img src="${logoUrl}" alt="${channel.name}" loading="lazy" class="w-full h-full object-contain p-2 group-hover:scale-105 transition duration-500 opacity-90 group-hover:opacity-100" onerror="this.src='https://placehold.co/400x225/1e293b/FFF?text=No+Image'">
                        
                        <!-- Overlay Play -->
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center backdrop-blur-[2px]">
                            <i class="ph ph-play-circle text-5xl text-brand-500 drop-shadow-xl scale-75 group-hover:scale-100 transition"></i>
                        </div>
                        
                        <!-- Fav Button -->
                        <button class="fav-btn absolute top-2 right-2 p-2 rounded-full bg-black/60 hover:bg-brand-600 transition z-10 ${isFav ? 'text-red-500' : 'text-gray-300'}" onclick="toggleFavorite('${channel.id}')" title="Favoritar">
                            <i class="ph ${isFav ? 'ph-heart-fill' : 'ph-heart'} text-lg"></i>
                        </button>
                    </div>
                    <div class="p-3 bg-dark-800 border-t border-dark-700 z-10 relative">
                        <h3 class="font-medium text-sm text-gray-200 truncate pr-4" title="${channel.name}">${channel.name}</h3>
                        <p class="text-[10px] text-brand-500 uppercase font-bold tracking-wider truncate mt-1">${channel.group}</p>
                    </div>
                `;
                grid.appendChild(card);
            });

            renderedCount += nextBatch.length;

            // Controle do botão "Carregar Mais"
            if (renderedCount < channels.length) {
                loadMoreBtn.classList.remove('hidden');
            } else {
                loadMoreBtn.classList.add('hidden');
            }
        }

        function loadMoreChannels() {
            renderChannels(filteredChannels, true);
        }

        // --- Filtros ---
        function filterCategory(category) {
            currentCategory = category;
            updateSidebarUI(category);

            document.getElementById('categoryTitle').textContent = 
                category === 'all' ? 'Todos os Canais' : 
                category === 'favorites' ? 'Meus Favoritos' : 
                category === 'live' ? 'TV Ao Vivo' :
                category === 'movies' ? 'Filmes' : 'Séries';

            applyFilters();
        }

        function filterByGroup(groupName) {
            updateSidebarUI(null, groupName); // Limpa seleção principal
            document.getElementById('categoryTitle').textContent = groupName;
            currentCategory = 'group';
            // Filtrar na hora
            const list = allChannels.filter(c => c.group === groupName);
            filteredChannels = list;
            renderChannels(list);
        }

        function updateSidebarUI(activeId, activeGroup = null) {
            // Reset Main Nav
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-brand-600/10', 'text-brand-500');
                el.classList.add('text-gray-400');
            });

            if (activeId) {
                const btn = document.querySelector(`button[onclick="filterCategory('${activeId}')"]`);
                if(btn) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('bg-brand-600/10', 'text-brand-500');
                }
            }
            
            // Reset Group List Styles
            const groupBtns = document.getElementById('groupList').children;
            for(let btn of groupBtns) {
                if (btn.textContent === activeGroup) {
                    btn.classList.add('text-brand-500', 'font-bold');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('text-brand-500', 'font-bold');
                    btn.classList.add('text-gray-400');
                }
            }
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            applyFilters(query);
        }

        function applyFilters(searchQuery = '') {
            let list = allChannels;

            // 1. Filtro Categoria
            if (currentCategory === 'favorites') {
                list = list.filter(c => favorites.includes(c.id));
            } else if (currentCategory !== 'all' && currentCategory !== 'group') {
                list = list.filter(c => c.type === currentCategory);
            }

            // 2. Filtro Busca (sobrepõe categoria se global, mas aqui refinamos dentro da categoria)
            const query = searchQuery || document.getElementById('searchInput').value.toLowerCase();
            
            if (query) {
                // Se a busca for feita na categoria "todos" ou "grupos", buscamos em tudo para facilitar
                if (currentCategory === 'all' || currentCategory === 'group') {
                    list = allChannels.filter(c => c.name.toLowerCase().includes(query));
                } else {
                    // Se estiver em "Filmes", busca só em filmes
                    list = list.filter(c => c.name.toLowerCase().includes(query));
                }
            }

            filteredChannels = list;
            renderChannels(list);
        }

        function toggleFavorite(id) {
            if (favorites.includes(id)) {
                favorites = favorites.filter(fav => fav !== id);
            } else {
                favorites.push(id);
            }
            localStorage.setItem('streamflow_favorites', JSON.stringify(favorites));
            
            // Atualiza UI sem recarregar tudo se possível
            if(currentCategory === 'favorites') {
                applyFilters();
            } else {
                // Apenas troca o ícone visualmente para performance
                // Mas chamando renderChannels preserva estado correto
                const btn = document.querySelector(`button[onclick="toggleFavorite('${id}')"]`);
                if(btn) {
                     // Hack visual rápido
                     const isFav = favorites.includes(id);
                     btn.innerHTML = `<i class="ph ${isFav ? 'ph-heart-fill' : 'ph-heart'} text-lg"></i>`;
                     btn.classList.toggle('text-red-500', isFav);
                     btn.classList.toggle('text-gray-300', !isFav);
                }
            }
        }

        // --- Player Logic ---
        function openPlayer(channel) {
            const overlay = document.getElementById('playerOverlay');
            const title = document.getElementById('playerTitle');
            const group = document.getElementById('playerGroup');
            const errorDiv = document.getElementById('playerError');

            overlay.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            
            title.textContent = channel.name;
            group.textContent = channel.group;

            // Verifica Mixed Content
            if (window.location.protocol === 'https:' && channel.url.startsWith('http:')) {
                // Aviso preventivo, mas tenta tocar
                console.warn("Tentando reproduzir HTTP em ambiente HTTPS");
            }

            initVideo(channel.url);
        }

        function initVideo(url) {
            if (Hls.isSupported()) {
                if(hls) {
                    hls.destroy();
                }
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    video.play().catch(() => {
                        // Autoplay bloqueado, mostra botão play gigante se quiser
                    });
                });
                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            hls.recoverMediaError();
                            break;
                        default:
                            handleVideoError();
                            hls.destroy();
                            break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari
                video.src = url;
                video.addEventListener('loadedmetadata', function() {
                    video.play();
                });
            } else {
                // Tenta source direta para MP4/MKV
                video.src = url;
                video.play().catch(handleVideoError);
            }
        }

        function closePlayer() {
            document.getElementById('playerOverlay').classList.add('hidden');
            video.pause();
            video.src = '';
            if(hls) {
                hls.destroy();
                hls = null;
            }
        }

        function handleVideoError() {
            document.getElementById('playerError').classList.remove('hidden');
        }

        function retryStream() {
            document.getElementById('playerError').classList.add('hidden');
            if(hls && hls.url) {
                hls.loadSource(hls.url);
                hls.attachMedia(video);
            } else if (video.src) {
                video.load();
                video.play();
            }
        }

        function toggleAspectRatio() {
            if (video.style.objectFit === 'cover') {
                video.style.objectFit = 'contain';
            } else {
                video.style.objectFit = 'cover';
            }
        }

        function resetApp() {
            if(confirm('Isso irá limpar a lista atual. Deseja continuar?')) {
                location.reload();
            }
        }

        // Atalho ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!document.getElementById('playerOverlay').classList.contains('hidden')) {
                    closePlayer();
                }
            }
        });

    </script>
</body>
</html>