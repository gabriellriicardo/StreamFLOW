<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlow - Web IPTV Player</title>
    
    <!-- Meta Tags -->
    <meta name="description" content="Player IPTV web com correção automática para listas TS/M3U8.">
    <meta name="theme-color" content="#0f172a">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HLS.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            500: '#6366f1',
                            600: '#4f46e5',
                        },
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .glass { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-dark-900 text-gray-100 font-sans antialiased overflow-hidden h-screen flex flex-col">

    <!-- Modal Setup -->
    <div id="setupModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-dark-800 p-8 rounded-2xl shadow-2xl w-full max-w-2xl border border-dark-700 m-4">
            <div class="text-center mb-8">
                <i class="ph ph-television-simple text-6xl text-brand-500 mb-4 inline-block"></i>
                <h1 class="text-3xl font-bold text-white mb-2">StreamFlow Player</h1>
                <p class="text-gray-400">Suporte adicionado para listas .TS e Xtream Codes</p>
            </div>

            <div class="space-y-6">
                <div class="flex border-b border-dark-700">
                    <button onclick="switchTab('file')" id="tab-file" class="flex-1 pb-4 text-brand-500 border-b-2 border-brand-500 font-medium transition">Arquivo .M3U</button>
                    <button onclick="switchTab('url')" id="tab-url" class="flex-1 pb-4 text-gray-400 hover:text-white font-medium transition">URL / Link</button>
                </div>

                <div id="content-file" class="tab-content block">
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-dark-700 rounded-lg cursor-pointer hover:bg-dark-700/50 transition bg-dark-800">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i class="ph ph-upload-simple text-3xl mb-2 text-gray-400"></i>
                            <p class="mb-2 text-sm text-gray-400"><span class="font-semibold">Clique para enviar</span> sua lista</p>
                            <p class="text-xs text-gray-500">Aceita .m3u, .m3u8 e .txt</p>
                        </div>
                        <input id="fileInput" type="file" class="hidden" accept=".m3u,.m3u8,.txt" />
                    </label>
                </div>

                <div id="content-url" class="tab-content hidden">
                    <div class="space-y-2">
                        <input id="urlInput" type="text" placeholder="Cole o link da sua lista aqui..." class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-3 focus:outline-none focus:border-brand-500 transition text-white">
                        <button onclick="loadFromUrl()" class="w-full bg-brand-600 hover:bg-brand-500 text-white px-6 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2">
                            Carregar Lista
                            <i class="ph ph-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div id="loadingState" class="hidden flex flex-col items-center justify-center py-4">
                    <div class="loader mb-3"></div>
                    <p id="loadingText" class="text-sm text-gray-400">Processando canais...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Layout Principal -->
    <div class="flex h-full">
        <!-- Sidebar -->
        <aside class="hidden lg:flex w-64 bg-dark-800 border-r border-dark-700 flex-col z-20">
            <div class="h-16 flex items-center px-6 border-b border-dark-700 shrink-0">
                <i class="ph ph-play-circle text-3xl text-brand-500"></i>
                <span class="ml-3 font-bold text-xl">StreamFlow</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 px-2 custom-scroll space-y-1">
                <!-- Botão Início Adicionado -->
                <button onclick="showHomeScreen()" class="nav-item w-full flex items-center p-3 rounded-lg bg-brand-600/10 text-brand-500" id="btn-home">
                    <i class="ph ph-house text-xl"></i>
                    <span class="ml-3 font-semibold">Início</span>
                </button>
                
                <div class="my-2 border-t border-dark-700 mx-2"></div>

                <button onclick="filterCategory('favorites')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:text-white">
                    <i class="ph ph-heart text-xl"></i><span class="ml-3">Favoritos</span>
                </button>
                <button onclick="filterCategory('live')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:text-white">
                    <i class="ph ph-television text-xl"></i><span class="ml-3">Canais TV</span>
                </button>
                <button onclick="filterCategory('movies')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:text-white">
                    <i class="ph ph-film-strip text-xl"></i><span class="ml-3">Filmes</span>
                </button>
                <button onclick="filterCategory('series')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:text-white">
                    <i class="ph ph-cards text-xl"></i><span class="ml-3">Séries</span>
                </button>
                <button onclick="filterCategory('all')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:text-white">
                    <i class="ph ph-squares-four text-xl"></i><span class="ml-3">Todos</span>
                </button>

                <div class="mt-6 px-3 mb-2 text-xs font-bold text-gray-500 uppercase">Grupos</div>
                <div id="groupList" class="space-y-1 pb-4"></div>
            </nav>
            <div class="p-4 border-t border-dark-700 shrink-0">
                <button onclick="location.reload()" class="flex items-center w-full text-red-400 hover:text-red-300 transition p-2 rounded hover:bg-red-400/10">
                    <i class="ph ph-sign-out text-xl"></i><span class="ml-3 text-sm font-medium">Trocar Lista</span>
                </button>
            </div>
        </aside>

        <!-- Main -->
        <main class="flex-1 flex flex-col bg-dark-900 relative min-w-0">
            <!-- Mobile Header -->
            <div class="lg:hidden h-16 bg-dark-800 border-b border-dark-700 flex items-center justify-between px-4 shrink-0">
                 <div class="flex items-center"><i class="ph ph-play-circle text-2xl text-brand-500"></i><span class="ml-2 font-bold text-lg">StreamFlow</span></div>
                <button onclick="document.getElementById('mobileMenu').classList.toggle('hidden')" class="text-white p-2"><i class="ph ph-list text-2xl"></i></button>
            </div>
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="hidden lg:hidden bg-dark-800 border-b border-dark-700 absolute top-16 left-0 right-0 z-30 p-4 shadow-xl">
                 <div class="grid grid-cols-2 gap-2">
                    <button onclick="showHomeScreen(); toggleMobileMenu()" class="p-2 bg-dark-700 rounded text-sm">Início</button>
                    <button onclick="filterCategory('favorites'); toggleMobileMenu()" class="p-2 bg-dark-700 rounded text-sm">Favoritos</button>
                 </div>
                 <button onclick="location.reload()" class="w-full mt-4 p-2 bg-red-900/30 text-red-400 rounded text-sm">Sair</button>
            </div>
            
            <!-- Topbar -->
            <header class="h-16 glass flex items-center justify-between px-4 lg:px-8 z-10 sticky top-0 shrink-0">
                <div class="flex items-center bg-dark-900/50 rounded-full px-4 py-2 w-full max-w-md border border-dark-700 focus-within:border-brand-500 transition">
                    <i class="ph ph-magnifying-glass text-gray-400 text-lg"></i>
                    <input id="searchInput" type="text" placeholder="Pesquisar canal..." class="bg-transparent border-none focus:outline-none text-white ml-3 w-full placeholder-gray-500">
                </div>
                <div class="text-right hidden sm:block">
                    <p id="channelCount" class="text-xs text-gray-400">0 canais</p>
                    <p class="text-sm font-semibold text-white truncate max-w-[150px]" id="categoryTitle">Início</p>
                </div>
            </header>

            <!-- CONTEÚDO PRINCIPAL -->
            <div id="mainContainer" class="flex-1 overflow-y-auto p-4 lg:p-6 custom-scroll relative">
                
                <!-- TELA INICIAL (Home Screen) -->
                <div id="homeScreen" class="hidden flex-col items-center justify-center min-h-[calc(100vh-10rem)] animate-fade-in">
                    <div class="text-center mb-10">
                        <h2 class="text-3xl lg:text-4xl font-bold text-white mb-2">O que você quer assistir?</h2>
                        <p class="text-gray-400">Selecione uma categoria para começar</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-5xl px-4">
                        <!-- Card TV Ao Vivo -->
                        <button onclick="filterCategory('live')" class="group relative h-48 md:h-64 bg-dark-800 rounded-2xl border border-dark-700 hover:border-brand-500 transition-all hover:scale-105 hover:shadow-2xl hover:shadow-brand-500/10 overflow-hidden flex flex-col items-center justify-center">
                            <div class="absolute inset-0 bg-gradient-to-br from-brand-600/10 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                            <div class="bg-dark-900 p-4 rounded-full mb-4 border border-dark-700 group-hover:border-brand-500/50 transition z-10">
                                <i class="ph ph-television text-4xl text-brand-500 group-hover:scale-110 transition"></i>
                            </div>
                            <span class="text-xl font-bold text-white z-10">TV Ao Vivo</span>
                            <span class="text-sm text-gray-400 mt-2 z-10 font-medium" id="count-live">0 Canais</span>
                        </button>

                        <!-- Card Filmes -->
                        <button onclick="filterCategory('movies')" class="group relative h-48 md:h-64 bg-dark-800 rounded-2xl border border-dark-700 hover:border-brand-500 transition-all hover:scale-105 hover:shadow-2xl hover:shadow-brand-500/10 overflow-hidden flex flex-col items-center justify-center">
                            <div class="absolute inset-0 bg-gradient-to-br from-purple-600/10 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                            <div class="bg-dark-900 p-4 rounded-full mb-4 border border-dark-700 group-hover:border-purple-500/50 transition z-10">
                                <i class="ph ph-film-strip text-4xl text-purple-500 group-hover:scale-110 transition"></i>
                            </div>
                            <span class="text-xl font-bold text-white z-10">Filmes</span>
                            <span class="text-sm text-gray-400 mt-2 z-10 font-medium" id="count-movies">0 Títulos</span>
                        </button>

                        <!-- Card Séries -->
                        <button onclick="filterCategory('series')" class="group relative h-48 md:h-64 bg-dark-800 rounded-2xl border border-dark-700 hover:border-brand-500 transition-all hover:scale-105 hover:shadow-2xl hover:shadow-brand-500/10 overflow-hidden flex flex-col items-center justify-center">
                            <div class="absolute inset-0 bg-gradient-to-br from-emerald-600/10 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                            <div class="bg-dark-900 p-4 rounded-full mb-4 border border-dark-700 group-hover:border-emerald-500/50 transition z-10">
                                <i class="ph ph-cards text-4xl text-emerald-500 group-hover:scale-110 transition"></i>
                            </div>
                            <span class="text-xl font-bold text-white z-10">Séries</span>
                            <span class="text-sm text-gray-400 mt-2 z-10 font-medium" id="count-series">0 Títulos</span>
                        </button>
                    </div>
                </div>

                <!-- LISTA DE CANAIS (Grid) -->
                <div id="channelsView" class="hidden">
                    <div id="contentGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-4 lg:gap-6 content-start pb-8"></div>
                    <div id="loadMoreContainer" class="hidden w-full flex justify-center py-8">
                        <button onclick="loadMoreChannels()" class="bg-dark-700 hover:bg-dark-600 text-white px-6 py-3 rounded-full font-medium transition shadow-lg">Carregar Mais</button>
                    </div>
                    <div id="emptyState" class="hidden flex flex-col items-center justify-center text-gray-500 py-20">
                        <i class="ph ph-ghost text-6xl mb-4"></i><p>Nada encontrado.</p>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Player -->
    <div id="playerOverlay" class="fixed inset-0 z-[60] bg-black hidden flex flex-col">
        <div class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/90 to-transparent z-20 flex justify-between items-center opacity-0 hover:opacity-100 transition-opacity duration-300">
            <div class="flex items-center gap-4">
                <button onclick="closePlayer()" class="text-white hover:text-brand-500 transition p-2 bg-black/40 rounded-full backdrop-blur-md"><i class="ph ph-arrow-left text-2xl"></i></button>
                <div>
                    <h2 id="playerTitle" class="text-white font-bold text-lg drop-shadow-md">Título</h2>
                    <p id="playerGroup" class="text-gray-300 text-xs drop-shadow-md">Info</p>
                </div>
            </div>
            <button onclick="toggleAspectRatio()" class="text-white hover:text-brand-500 transition p-2 bg-black/40 rounded-full backdrop-blur-md"><i class="ph ph-frame-corners text-2xl"></i></button>
        </div>

        <div class="flex-1 relative flex items-center justify-center bg-black w-full h-full">
            <video id="videoPlayer" class="w-full h-full" controls autoplay playsinline></video>
            <div id="playerError" class="hidden absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-center p-4 z-10">
                <i class="ph ph-warning-octagon text-5xl text-red-500 mb-4"></i>
                <h3 class="text-xl font-bold text-white mb-2">Erro de Reprodução</h3>
                <p class="text-gray-400 mb-6 max-w-md">O stream não respondeu. Pode estar offline ou bloqueado por segurança (Mixed Content).</p>
                <div class="flex gap-4">
                    <button onclick="closePlayer()" class="px-6 py-2 border border-gray-600 text-white rounded hover:bg-gray-800">Voltar</button>
                    <button onclick="retryStream()" class="px-6 py-2 bg-brand-600 text-white rounded hover:bg-brand-500">Tentar Novamente</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Core Logic ---
        let allChannels = [];
        let filteredChannels = [];
        let favorites = JSON.parse(localStorage.getItem('streamflow_favorites') || '[]');
        let currentCategory = 'home'; // Inicializa em Home
        let hls = null;
        let renderedCount = 0;
        const BATCH_SIZE = 48; 
        const video = document.getElementById('videoPlayer');

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            video.addEventListener('error', handleVideoError);
        });

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- Parsing M3U AVANÇADO ---
        function parseM3U(content) {
            const lines = content.split(/\r?\n/);
            const channels = [];
            let currentChannel = { name: '', logo: '', group: 'Geral', url: '' };
            let hasInfo = false;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;

                if (line.startsWith('#EXTINF:')) {
                    hasInfo = true;
                    currentChannel = { name: '', logo: '', group: 'Geral', url: '' };
                    
                    const infoData = line.substring(8);
                    const lastCommaIndex = infoData.lastIndexOf(',');
                    currentChannel.name = lastCommaIndex !== -1 ? infoData.substring(lastCommaIndex + 1).trim() : "Canal Sem Nome";

                    const logoMatch = line.match(/tvg-logo=["']([^"']*)["']/i);
                    if (logoMatch) currentChannel.logo = logoMatch[1];

                    const groupMatch = line.match(/group-title=["']([^"']*)["']/i);
                    if (groupMatch) {
                        currentChannel.group = groupMatch[1];
                    } else if (currentChannel.name.toUpperCase().includes('FILMES')) {
                        currentChannel.group = "Filmes";
                    }
                    
                    const groupLower = currentChannel.group.toLowerCase();
                    if (groupLower.match(/movie|filme|cinema|cine/)) currentChannel.type = 'movies';
                    else if (groupLower.match(/series|série|temporada/)) currentChannel.type = 'series';
                    else currentChannel.type = 'live';

                } else if (isValidUrlLine(line)) {
                    if (line.startsWith('://')) {
                        line = 'http' + line; 
                    }
                    
                    currentChannel.url = line;
                    
                    if (!hasInfo) {
                        currentChannel.name = `Canal ${channels.length + 1}`;
                        currentChannel.type = 'live';
                    }

                    if (currentChannel.name && currentChannel.url) {
                        currentChannel.id = generateId(currentChannel.url);
                        channels.push({ ...currentChannel });
                    }
                    hasInfo = false;
                }
            }
            return channels;
        }

        function isValidUrlLine(line) {
            return line.startsWith('http') || line.startsWith('rtmp') || line.startsWith('://') || (line.endsWith('.ts') && !line.startsWith('#')) || (line.endsWith('.m3u8') && !line.startsWith('#'));
        }

        function generateId(url) {
            let hash = 0;
            for (let i = 0; i < url.length; i++) {
                hash = ((hash << 5) - hash) + url.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash).toString(36);
        }

        // --- Carregamento ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            setLoading(true, "Lendo arquivo...");
            const reader = new FileReader();
            reader.onload = (e) => processPlaylist(e.target.result);
            reader.readAsText(file);
        }

        async function loadFromUrl() {
            let url = document.getElementById('urlInput').value.trim();
            if(!url) return;
            setLoading(true, "Baixando lista...");
            
            try {
                let response = await fetch(url);
                if (!response.ok) throw new Error('Falha direta');
                let text = await response.text();
                processPlaylist(text);
            } catch (err) {
                setLoading(true, "Tentando Proxy...");
                try {
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    const data = await response.json();
                    if (data.contents) processPlaylist(data.contents);
                    else throw new Error("Vazio");
                } catch (proxyErr) {
                    alert('Erro ao baixar lista. Tente baixar o arquivo .m3u no seu PC e usar a primeira opção.');
                    setLoading(false);
                }
            }
        }

        function processPlaylist(content) {
            setLoading(true, "Processando...");
            setTimeout(() => {
                allChannels = parseM3U(content);
                if (allChannels.length === 0) {
                    alert('Nenhum canal encontrado. Verifique se o arquivo está correto.');
                    setLoading(false);
                    return;
                }
                allChannels.sort((a, b) => a.name.localeCompare(b.name));
                
                document.getElementById('setupModal').classList.add('hidden');
                populateGroups();
                updateHomeCounts();
                showHomeScreen(); // MOSTRA A TELA INICIAL
                setLoading(false);
            }, 100);
        }

        function updateHomeCounts() {
            const liveCount = allChannels.filter(c => c.type === 'live').length;
            const moviesCount = allChannels.filter(c => c.type === 'movies').length;
            const seriesCount = allChannels.filter(c => c.type === 'series').length;

            document.getElementById('count-live').textContent = `${liveCount} Canais`;
            document.getElementById('count-movies').textContent = `${moviesCount} Títulos`;
            document.getElementById('count-series').textContent = `${seriesCount} Títulos`;
        }

        function setLoading(active, text = "") {
            const el = document.getElementById('loadingState');
            if (active) {
                el.classList.remove('hidden');
                document.getElementById('loadingText').textContent = text;
            } else {
                el.classList.add('hidden');
            }
        }

        // --- Renderização ---
        function populateGroups() {
            const groups = [...new Set(allChannels.map(c => c.group))].sort();
            const groupList = document.getElementById('groupList');
            groupList.innerHTML = '';
            groups.forEach(group => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left px-3 py-2 text-sm text-gray-400 hover:text-white hover:bg-dark-700 rounded truncate transition';
                btn.textContent = group;
                btn.onclick = () => { filterByGroup(group); toggleMobileMenu(); };
                groupList.appendChild(btn);
            });
        }

        function showHomeScreen() {
            currentCategory = 'home';
            document.getElementById('homeScreen').classList.remove('hidden');
            document.getElementById('homeScreen').classList.add('flex'); // Ensure flex display
            document.getElementById('channelsView').classList.add('hidden');
            
            updateSidebarUI('home');
            document.getElementById('categoryTitle').textContent = 'Início';
            document.getElementById('channelCount').textContent = `${allChannels.length} total`;
        }

        function renderChannels(channels, append = false) {
            const grid = document.getElementById('contentGrid');
            const empty = document.getElementById('emptyState');
            const loadMoreBtn = document.getElementById('loadMoreContainer');
            const countEl = document.getElementById('channelCount');
            
            // Troca da Home para Grid
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('homeScreen').classList.remove('flex');
            document.getElementById('channelsView').classList.remove('hidden');

            if (!append) {
                grid.innerHTML = '';
                renderedCount = 0;
                document.getElementById('mainContainer').scrollTop = 0;
            }

            countEl.innerText = `${channels.length} canais`;

            if (channels.length === 0) {
                empty.classList.remove('hidden');
                loadMoreBtn.classList.add('hidden');
                return;
            }
            empty.classList.add('hidden');

            const nextBatch = channels.slice(renderedCount, renderedCount + BATCH_SIZE);
            nextBatch.forEach(channel => {
                const isFav = favorites.includes(channel.id);
                const card = document.createElement('div');
                card.className = 'group relative bg-dark-800 rounded-lg overflow-hidden cursor-pointer card-hover transition-all duration-300 aspect-video flex flex-col border border-dark-700';
                card.onclick = (e) => { if(!e.target.closest('.fav-btn')) openPlayer(channel); };

                let logoUrl = channel.logo;
                if (!logoUrl || logoUrl.length < 5) {
                    const initials = channel.name.substring(0,2).toUpperCase();
                    logoUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=1e293b&color=6366f1&size=256&font-size=0.4&bold=true`;
                }

                card.innerHTML = `
                    <div class="relative flex-1 bg-black w-full overflow-hidden">
                        <img src="${logoUrl}" alt="${channel.name}" loading="lazy" class="w-full h-full object-contain p-2 group-hover:scale-105 transition duration-500 opacity-90 group-hover:opacity-100" onerror="this.src='https://placehold.co/400x225/1e293b/FFF?text=No+Image'">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center backdrop-blur-[2px]">
                            <i class="ph ph-play-circle text-5xl text-brand-500 drop-shadow-xl scale-75 group-hover:scale-100 transition"></i>
                        </div>
                        <button class="fav-btn absolute top-2 right-2 p-2 rounded-full bg-black/60 hover:bg-brand-600 transition z-10 ${isFav ? 'text-red-500' : 'text-gray-300'}" onclick="toggleFavorite('${channel.id}')">
                            <i class="ph ${isFav ? 'ph-heart-fill' : 'ph-heart'} text-lg"></i>
                        </button>
                    </div>
                    <div class="p-3 bg-dark-800 border-t border-dark-700 z-10 relative">
                        <h3 class="font-medium text-sm text-gray-200 truncate pr-4" title="${channel.name}">${channel.name}</h3>
                        <p class="text-[10px] text-brand-500 uppercase font-bold tracking-wider truncate mt-1">${channel.group}</p>
                    </div>
                `;
                grid.appendChild(card);
            });

            renderedCount += nextBatch.length;
            loadMoreBtn.classList.toggle('hidden', renderedCount >= channels.length);
        }

        function loadMoreChannels() { renderChannels(filteredChannels, true); }
        
        function filterCategory(cat) { 
            currentCategory = cat; 
            updateSidebarUI(cat); 
            applyFilters(); 
        }

        function filterByGroup(group) { 
            updateSidebarUI(null, group); 
            currentCategory = 'group'; 
            filteredChannels = allChannels.filter(c => c.group === group); 
            renderChannels(filteredChannels); 
        }

        function updateSidebarUI(activeId, activeGroup = null) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-brand-600/10', 'text-brand-500');
                el.classList.add('text-gray-400');
            });

            // Tratamento especial para o botão Home
            if (activeId === 'home') {
                const homeBtn = document.getElementById('btn-home');
                if(homeBtn) {
                    homeBtn.classList.remove('text-gray-400');
                    homeBtn.classList.add('bg-brand-600/10', 'text-brand-500');
                }
                return;
            }

            if (activeId) {
                const btn = document.querySelector(`button[onclick="filterCategory('${activeId}')"]`);
                if(btn) { btn.classList.remove('text-gray-400'); btn.classList.add('bg-brand-600/10', 'text-brand-500'); }
            }
            Array.from(document.getElementById('groupList').children).forEach(btn => {
                if(btn.textContent === activeGroup) { btn.classList.add('text-brand-500', 'font-bold'); btn.classList.remove('text-gray-400'); }
                else { btn.classList.remove('text-brand-500', 'font-bold'); btn.classList.add('text-gray-400'); }
            });
            document.getElementById('categoryTitle').textContent = activeGroup || (activeId === 'all' ? 'Todos' : activeId === 'favorites' ? 'Favoritos' : activeId);
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            // Se começar a digitar, sai da home e vai para a busca global ou da categoria atual
            if (currentCategory === 'home' && query.length > 0) {
                 filterCategory('all');
            }
            applyFilters(query);
        }

        function applyFilters(searchQuery = '') {
            let list = allChannels;
            if (currentCategory === 'favorites') list = list.filter(c => favorites.includes(c.id));
            else if (currentCategory !== 'all' && currentCategory !== 'group' && currentCategory !== 'home') list = list.filter(c => c.type === currentCategory);

            const query = searchQuery || document.getElementById('searchInput').value.toLowerCase();
            if (query) list = list.filter(c => c.name.toLowerCase().includes(query) || c.group.toLowerCase().includes(query));
            
            filteredChannels = list;
            renderChannels(list);
        }

        function toggleFavorite(id) {
            favorites = favorites.includes(id) ? favorites.filter(fav => fav !== id) : [...favorites, id];
            localStorage.setItem('streamflow_favorites', JSON.stringify(favorites));
            const btn = document.querySelector(`button[onclick="toggleFavorite('${id}')"]`);
            if(btn) {
                 const isFav = favorites.includes(id);
                 btn.innerHTML = `<i class="ph ${isFav ? 'ph-heart-fill' : 'ph-heart'} text-lg"></i>`;
                 btn.classList.toggle('text-red-500', isFav);
                 btn.classList.toggle('text-gray-300', !isFav);
            }
            if(currentCategory === 'favorites') applyFilters();
        }

        function toggleMobileMenu() { document.getElementById('mobileMenu').classList.add('hidden'); }

        // --- Player ---
        function openPlayer(channel) {
            document.getElementById('playerOverlay').classList.remove('hidden');
            document.getElementById('playerError').classList.add('hidden');
            document.getElementById('playerTitle').textContent = channel.name;
            document.getElementById('playerGroup').textContent = channel.group;

            let playUrl = channel.url;
            if (playUrl.includes('.ts')) {
                console.log("Convertendo stream TS para M3U8 para compatibilidade web...");
                playUrl = playUrl.replace('.ts', '.m3u8');
            }

            initVideo(playUrl);
        }

        function initVideo(url) {
            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
                hls.on(Hls.Events.ERROR, (e, data) => {
                    if (data.fatal) {
                        if(data.type === Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
                        else handleVideoError();
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.play();
            }
        }

        function closePlayer() {
            document.getElementById('playerOverlay').classList.add('hidden');
            video.pause();
            video.src = '';
            if(hls) { hls.destroy(); hls = null; }
        }

        function handleVideoError() { document.getElementById('playerError').classList.remove('hidden'); }
        function retryStream() { 
            document.getElementById('playerError').classList.add('hidden'); 
            if(hls && hls.url) { hls.loadSource(hls.url); hls.attachMedia(video); }
            else if (video.src) { video.load(); video.play(); }
        }
        function toggleAspectRatio() { video.style.objectFit = video.style.objectFit === 'cover' ? 'contain' : 'cover'; }
        
        function switchTab(t){
             ['file','url'].forEach(x=>document.getElementById(`tab-${x}`).className=`flex-1 pb-4 font-medium transition ${x===t?'text-brand-500 border-b-2 border-brand-500':'text-gray-400'}`);
             ['file','url'].forEach(x=>document.getElementById(`content-${x}`).classList.toggle('hidden', x!==t));
        }
    </script>
</body>
</html>
