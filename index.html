<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayerFLOW - Web IPTV Player</title>
    <!-- REMOVIDO: upgrade-insecure-requests (Causava loop infinito em servidores apenas HTTP) -->
    <meta name="referrer" content="no-referrer">
    
    <!-- Meta Tags -->
    <meta name="description" content="Player IPTV web com corre√ß√£o autom√°tica para listas TS/M3U8.">
    <meta name="theme-color" content="#0f172a">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HLS.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            500: '#6366f1',
                            600: '#4f46e5',
                        },
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .glass { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-dark-900 text-gray-100 font-sans antialiased overflow-hidden h-screen flex flex-col">

    <!-- Modal Setup -->
    <div id="setupModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-dark-800 p-8 rounded-2xl shadow-2xl w-full max-w-2xl border border-dark-700 m-4">
            <div class="text-center mb-8">
                <i class="ph ph-television-simple text-6xl text-brand-500 mb-4 inline-block"></i>
                <h1 class="text-3xl font-bold text-white mb-2">PlayerFLOW</h1>
                <p class="text-gray-400">Arraste sua lista para come√ßar</p>
            </div>

            <div class="space-y-6">
                <div class="flex border-b border-dark-700">
                    <button onclick="switchTab('file')" id="tab-file" class="flex-1 pb-4 text-brand-500 border-b-2 border-brand-500 font-medium transition">Arquivo .M3U</button>
                    <button onclick="switchTab('url')" id="tab-url" class="flex-1 pb-4 text-gray-400 hover:text-white font-medium transition">URL / Link</button>
                </div>

                <div id="content-file" class="tab-content block">
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-dark-700 rounded-lg cursor-pointer hover:bg-dark-700/50 transition bg-dark-800">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i class="ph ph-upload-simple text-3xl mb-2 text-gray-400"></i>
                            <p class="mb-2 text-sm text-gray-400"><span class="font-semibold">Clique para enviar</span> sua lista</p>
                            <p class="text-xs text-gray-500">Aceita .m3u, .m3u8 e .txt</p>
                        </div>
                        <input id="fileInput" type="file" class="hidden" accept=".m3u,.m3u8,.txt" />
                    </label>
                </div>

                <div id="content-url" class="tab-content hidden">
                    <div class="space-y-2">
                        <input id="urlInput" type="text" placeholder="Cole o link da sua lista aqui..." class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-3 focus:outline-none focus:border-brand-500 transition text-white">
                        <button onclick="loadFromUrl()" class="w-full bg-brand-600 hover:bg-brand-500 text-white px-6 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2">
                            Carregar Lista
                            <i class="ph ph-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div id="loadingState" class="hidden flex flex-col items-center justify-center py-4">
                    <div class="loader mb-3"></div>
                    <p id="loadingText" class="text-sm text-gray-400">Processando canais...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Layout Principal -->
    <div class="flex h-full">
        <!-- Sidebar (Adicionado ID mainSidebar para controle) -->
        <aside class="hidden lg:flex w-64 bg-dark-800 border-r border-dark-700 flex-col z-20 transition-all duration-300" id="mainSidebar">
            <div class="h-16 flex items-center px-6 border-b border-dark-700 shrink-0">
                <i class="ph ph-play-circle text-3xl text-brand-500"></i>
                <span class="ml-3 font-bold text-xl">PlayerFLOW</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 px-2 custom-scroll space-y-1">
                <!-- Bot√£o In√≠cio -->
                <button onclick="showHomeScreen()" class="nav-item w-full flex items-center p-3 rounded-lg bg-brand-600/10 text-brand-500" id="btn-home">
                    <i class="ph ph-house text-xl"></i>
                    <span class="ml-3 font-semibold">In√≠cio</span>
                </button>
                
                <div class="my-2 border-t border-dark-700 mx-2"></div>

                <button onclick="filterCategory('favorites')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:text-white">
                    <i class="ph ph-heart text-xl"></i><span class="ml-3">Favoritos</span>
                </button>
                <button onclick="filterCategory('live')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:text-white">
                    <i class="ph ph-television text-xl"></i><span class="ml-3">Canais TV</span>
                </button>
                <button onclick="filterCategory('movies')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:text-white">
                    <i class="ph ph-film-strip text-xl"></i><span class="ml-3">Filmes</span>
                </button>
                <button onclick="filterCategory('series')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:text-white">
                    <i class="ph ph-cards text-xl"></i><span class="ml-3">S√©ries</span>
                </button>
                <button onclick="filterCategory('all')" class="nav-item w-full flex items-center p-3 rounded-lg text-gray-400 hover:text-white">
                    <i class="ph ph-squares-four text-xl"></i><span class="ml-3">Todos</span>
                </button>

                <div class="mt-6 px-3 mb-2 text-xs font-bold text-gray-500 uppercase">Grupos R√°pidos</div>
                <div id="groupList" class="space-y-1 pb-4"></div>
            </nav>
            <div class="p-4 border-t border-dark-700 shrink-0">
                <button onclick="location.reload()" class="flex items-center w-full text-red-400 hover:text-red-300 transition p-2 rounded hover:bg-red-400/10">
                    <i class="ph ph-sign-out text-xl"></i><span class="ml-3 text-sm font-medium">Trocar Lista</span>
                </button>
            </div>
        </aside>

        <!-- Main -->
        <main class="flex-1 flex flex-col bg-dark-900 relative min-w-0 transition-all duration-300">
            <!-- Mobile Header (Adicionado ID mobileHeader) -->
            <div class="lg:hidden h-16 bg-dark-800 border-b border-dark-700 flex items-center justify-between px-4 shrink-0" id="mobileHeader">
                 <div class="flex items-center"><i class="ph ph-play-circle text-2xl text-brand-500"></i><span class="ml-2 font-bold text-lg">PlayerFLOW</span></div>
                <button onclick="document.getElementById('mobileMenu').classList.toggle('hidden')" class="text-white p-2"><i class="ph ph-list text-2xl"></i></button>
            </div>
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="hidden lg:hidden bg-dark-800 border-b border-dark-700 absolute top-16 left-0 right-0 z-30 p-4 shadow-xl">
                 <div class="grid grid-cols-2 gap-2">
                    <button onclick="showHomeScreen(); toggleMobileMenu()" class="p-2 bg-dark-700 rounded text-sm">In√≠cio</button>
                    <button onclick="filterCategory('favorites'); toggleMobileMenu()" class="p-2 bg-dark-700 rounded text-sm">Favoritos</button>
                 </div>
                 <button onclick="location.reload()" class="w-full mt-4 p-2 bg-red-900/30 text-red-400 rounded text-sm">Sair</button>
            </div>
            
            <!-- Topbar (Adicionado ID mainHeader) -->
            <header class="h-16 glass flex items-center justify-between px-4 lg:px-8 z-10 sticky top-0 shrink-0" id="mainHeader">
                <div class="flex items-center bg-dark-900/50 rounded-full px-4 py-2 w-full max-w-md border border-dark-700 focus-within:border-brand-500 transition">
                    <i class="ph ph-magnifying-glass text-gray-400 text-lg"></i>
                    <input id="searchInput" type="text" placeholder="Pesquisar..." class="bg-transparent border-none focus:outline-none text-white ml-3 w-full placeholder-gray-500">
                </div>
                <div class="text-right hidden sm:block">
                    <p id="channelCount" class="text-xs text-gray-400">0 itens</p>
                    <p class="text-sm font-semibold text-white truncate max-w-[150px]" id="categoryTitle">In√≠cio</p>
                </div>
            </header>

            <!-- CONTE√öDO PRINCIPAL -->
            <div id="mainContainer" class="flex-1 overflow-y-auto p-4 lg:p-6 custom-scroll relative">
                
                <!-- TELA 1: HOME (CART√ïES) -->
                <div id="homeScreen" class="hidden flex-col items-center justify-center min-h-[calc(100vh-10rem)] animate-fade-in w-full">
                    <div class="text-center mb-10">
                        <div class="flex items-center justify-center gap-2 mb-2">
                            <i class="ph ph-play-circle text-5xl text-brand-500"></i>
                            <h1 class="text-4xl lg:text-5xl font-bold text-white tracking-tight">PlayerFLOW</h1>
                        </div>
                        <p class="text-gray-400 text-lg">Seu universo de entretenimento</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-5xl px-4">
                        <!-- Card TV Ao Vivo -->
                        <button onclick="filterCategory('live')" class="group relative h-64 md:h-80 bg-dark-800 rounded-3xl border border-dark-700 hover:border-brand-500 transition-all hover:scale-105 hover:shadow-2xl hover:shadow-brand-500/20 overflow-hidden flex flex-col items-center justify-center">
                            <div class="absolute inset-0 bg-gradient-to-br from-brand-600/20 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                            <div class="bg-dark-900 p-6 rounded-full mb-6 border border-dark-700 group-hover:border-brand-500/50 transition z-10 shadow-lg">
                                <i class="ph ph-television text-5xl text-brand-500 group-hover:scale-110 transition"></i>
                            </div>
                            <span class="text-2xl font-bold text-white z-10">TV Ao Vivo</span>
                            <span class="text-sm text-gray-400 mt-2 z-10 font-medium bg-dark-900/50 px-3 py-1 rounded-full" id="count-live">0 Canais</span>
                        </button>

                        <!-- Card Filmes -->
                        <button onclick="filterCategory('movies')" class="group relative h-64 md:h-80 bg-dark-800 rounded-3xl border border-dark-700 hover:border-brand-500 transition-all hover:scale-105 hover:shadow-2xl hover:shadow-brand-500/20 overflow-hidden flex flex-col items-center justify-center">
                            <div class="absolute inset-0 bg-gradient-to-br from-purple-600/20 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                            <div class="bg-dark-900 p-6 rounded-full mb-6 border border-dark-700 group-hover:border-purple-500/50 transition z-10 shadow-lg">
                                <i class="ph ph-film-strip text-5xl text-purple-500 group-hover:scale-110 transition"></i>
                            </div>
                            <span class="text-2xl font-bold text-white z-10">Filmes</span>
                            <span class="text-sm text-gray-400 mt-2 z-10 font-medium bg-dark-900/50 px-3 py-1 rounded-full" id="count-movies">0 T√≠tulos</span>
                        </button>

                        <!-- Card S√©ries -->
                        <button onclick="filterCategory('series')" class="group relative h-64 md:h-80 bg-dark-800 rounded-3xl border border-dark-700 hover:border-brand-500 transition-all hover:scale-105 hover:shadow-2xl hover:shadow-brand-500/20 overflow-hidden flex flex-col items-center justify-center">
                            <div class="absolute inset-0 bg-gradient-to-br from-emerald-600/20 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                            <div class="bg-dark-900 p-6 rounded-full mb-6 border border-dark-700 group-hover:border-emerald-500/50 transition z-10 shadow-lg">
                                <i class="ph ph-cards text-5xl text-emerald-500 group-hover:scale-110 transition"></i>
                            </div>
                            <span class="text-2xl font-bold text-white z-10">S√©ries</span>
                            <span class="text-sm text-gray-400 mt-2 z-10 font-medium bg-dark-900/50 px-3 py-1 rounded-full" id="count-series">0 T√≠tulos</span>
                        </button>
                    </div>

                    <!-- Bot√£o Favoritos na Home -->
                    <button onclick="filterCategory('favorites')" class="mt-10 flex items-center gap-2 text-gray-400 hover:text-red-400 transition-colors px-6 py-2 rounded-full border border-dark-700 hover:border-red-500/50 hover:bg-dark-800">
                        <i class="ph ph-heart-fill"></i>
                        <span>Acessar Favoritos</span>
                    </button>
                </div>

                <!-- TELA 2: SUBCATEGORIAS (PASTAS) -->
                <div id="subcategoriesView" class="hidden w-full max-w-7xl mx-auto animate-fade-in pt-4">
                    <div class="flex items-center mb-6">
                        <button onclick="showHomeScreen()" class="mr-4 p-2 rounded-full hover:bg-dark-800 text-gray-400 hover:text-white transition">
                            <i class="ph ph-arrow-left text-2xl"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-white" id="subcategoryTitle">Categorias</h2>
                    </div>
                    <div id="subcategoriesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <!-- Cards de Categorias injetados via JS -->
                    </div>
                </div>

                <!-- TELA 3: LISTA DE CANAIS/CONTE√öDO (Grid Final) -->
                <div id="channelsView" class="hidden w-full max-w-7xl mx-auto pt-4">
                    <div class="flex items-center mb-4" id="channelsHeader">
                        <button onclick="goBackToSubcategories()" class="mr-4 p-2 rounded-full hover:bg-dark-800 text-gray-400 hover:text-white transition">
                            <i class="ph ph-arrow-left text-2xl"></i>
                        </button>
                        <h2 class="text-xl font-bold text-white truncate" id="currentGroupTitle">Lista</h2>
                    </div>

                    <div id="contentGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-4 lg:gap-6 content-start pb-8"></div>
                    <div id="loadMoreContainer" class="hidden w-full flex justify-center py-8">
                        <button onclick="loadMoreChannels()" class="bg-dark-700 hover:bg-dark-600 text-white px-6 py-3 rounded-full font-medium transition shadow-lg">Carregar Mais</button>
                    </div>
                    <div id="emptyState" class="hidden flex flex-col items-center justify-center text-gray-500 py-20">
                        <i class="ph ph-ghost text-6xl mb-4"></i><p>Nada encontrado.</p>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Player -->
    <div id="playerOverlay" class="fixed inset-0 z-[60] bg-black hidden flex flex-col">
        <div class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/90 to-transparent z-20 flex justify-between items-center opacity-0 hover:opacity-100 transition-opacity duration-300">
            <div class="flex items-center gap-4">
                <button onclick="closePlayer()" class="text-white hover:text-brand-500 transition p-2 bg-black/40 rounded-full backdrop-blur-md"><i class="ph ph-arrow-left text-2xl"></i></button>
                <div>
                    <h2 id="playerTitle" class="text-white font-bold text-lg drop-shadow-md">T√≠tulo</h2>
                    <p id="playerGroup" class="text-gray-300 text-xs drop-shadow-md">Info</p>
                </div>
            </div>
            <button onclick="toggleAspectRatio()" class="text-white hover:text-brand-500 transition p-2 bg-black/40 rounded-full backdrop-blur-md"><i class="ph ph-frame-corners text-2xl"></i></button>
        </div>

        <div class="flex-1 relative flex items-center justify-center bg-black w-full h-full">
            <video id="videoPlayer" class="w-full h-full" controls autoplay playsinline></video>
            
            <div id="loadingOverlay" class="absolute inset-0 flex items-center justify-center pointer-events-none hidden">
                <div class="loader"></div>
            </div>

            <!-- Mensagem de Erro Avan√ßada -->
            <div id="playerError" class="hidden absolute inset-0 bg-black/95 flex flex-col items-center justify-center text-center p-6 z-10">
                <i class="ph ph-lock-key text-5xl text-yellow-500 mb-4 animate-bounce"></i>
                <h3 class="text-xl font-bold text-white mb-2">Conte√∫do Bloqueado pelo Navegador</h3>
                <div class="bg-dark-800 p-4 rounded-lg max-w-md text-sm text-left mb-6 border border-dark-700">
                    <p class="text-gray-300 mb-2"><strong class="text-white">Aten√ß√£o:</strong> O site √© seguro (HTTPS), mas sua lista usa canais antigos (HTTP).</p>
                    <p class="text-gray-400 mb-4">O navegador bloqueou o v√≠deo por seguran√ßa. Para assistir, voc√™ precisa permitir:</p>
                    
                    <p class="text-brand-500 font-bold mb-1">Como resolver (Chrome/Edge/PC):</p>
                    <ol class="list-decimal list-inside text-gray-300 space-y-1 mb-4">
                        <li>Clique no cadeado üîí na barra de endere√ßo (ao lado da URL).</li>
                        <li>Clique em "Configura√ß√µes do Site".</li>
                        <li>Procure por <strong>"Conte√∫do n√£o seguro"</strong> e mude para <strong>"Permitir"</strong>.</li>
                        <li>Recarregue a p√°gina.</li>
                    </ol>
                    <p class="text-xs text-gray-500">Nota: Em celulares, pode ser necess√°rio usar um navegador que suporte "Mixed Content" ou usar o app VLC.</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="closePlayer()" class="px-6 py-2 border border-gray-600 text-white rounded hover:bg-gray-800">Voltar</button>
                    <button onclick="location.reload()" class="px-6 py-2 bg-brand-600 text-white rounded hover:bg-brand-500">J√° Permiti (Recarregar)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Core Logic ---
        let allChannels = [];
        let filteredChannels = [];
        let favorites = JSON.parse(localStorage.getItem('streamflow_favorites') || '[]');
        let currentCategory = 'home'; 
        let currentSubCategoryType = null; 
        let hls = null;
        let renderedCount = 0;
        let loadTimeout = null;
        const BATCH_SIZE = 48; 
        const video = document.getElementById('videoPlayer');

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            video.addEventListener('error', handleVideoError);
            video.addEventListener('waiting', () => {
                document.getElementById('loadingOverlay').classList.remove('hidden');
                // Se ficar carregando por 10s, assume bloqueio de mixed content
                clearTimeout(loadTimeout);
                loadTimeout = setTimeout(() => {
                    if (video.networkState === 2) { // 2 = Loading
                        handleVideoError();
                    }
                }, 10000);
            });
            video.addEventListener('playing', () => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                clearTimeout(loadTimeout);
            });
        });

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- Layout Control ---
        function toggleLayout(isHome) {
            const sidebar = document.getElementById('mainSidebar');
            const mainHeader = document.getElementById('mainHeader');
            const mobileHeader = document.getElementById('mobileHeader');

            if (isHome) {
                sidebar.classList.remove('lg:flex');
                sidebar.classList.add('hidden');
                mainHeader.classList.remove('flex');
                mainHeader.classList.add('hidden');
                mobileHeader.classList.remove('flex');
                mobileHeader.classList.add('hidden');
            } else {
                sidebar.classList.add('lg:flex');
                sidebar.classList.remove('hidden');
                mainHeader.classList.add('flex');
                mainHeader.classList.remove('hidden');
                mobileHeader.classList.add('flex');
                mobileHeader.classList.remove('hidden');
            }
        }

        // --- Parser Refor√ßado para URLs Quebradas ---
        function parseM3U(content) {
            const lines = content.split(/\r?\n/);
            const channels = [];
            let currentChannel = { name: '', logo: '', group: 'Geral', url: '' };
            let hasInfo = false;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;
                if (line.startsWith('#EXTINF:')) {
                    hasInfo = true;
                    currentChannel = { name: '', logo: '', group: 'Geral', url: '' };
                    const infoData = line.substring(8);
                    const lastCommaIndex = infoData.lastIndexOf(',');
                    currentChannel.name = lastCommaIndex !== -1 ? infoData.substring(lastCommaIndex + 1).trim() : "Canal Sem Nome";
                    const logoMatch = line.match(/tvg-logo=["']([^"']*)["']/i);
                    if (logoMatch) currentChannel.logo = logoMatch[1];
                    const groupMatch = line.match(/group-title=["']([^"']*)["']/i);
                    if (groupMatch) {
                        currentChannel.group = groupMatch[1];
                    } else if (currentChannel.name.toUpperCase().includes('FILMES')) {
                        currentChannel.group = "Filmes";
                    }
                    const groupLower = currentChannel.group.toLowerCase();
                    if (groupLower.match(/movie|filme|cinema|cine/)) currentChannel.type = 'movies';
                    else if (groupLower.match(/series|s√©rie|temporada/)) currentChannel.type = 'series';
                    else currentChannel.type = 'live';
                } else if (isValidUrlLine(line)) {
                    // CORRE√á√ÉO CR√çTICA DE URL PARA SUA LISTA
                    if (line.startsWith('://')) {
                         // Remove "://" inicial e reconstr√≥i
                         // Ex: ://1fcpbqww8.vip:/759654...
                         // 1. Remove ://
                         let clean = line.substring(3);
                         // 2. Procura pela primeira ocorr√™ncia de ":/" e substitui por "/" para arrumar porta vazia
                         clean = clean.replace(':/', '/');
                         // 3. Adiciona http://
                         line = 'http://' + clean; 
                    }
                    
                    currentChannel.url = line;
                    if (!hasInfo) {
                        currentChannel.name = `Canal ${channels.length + 1}`;
                        currentChannel.type = 'live';
                    }
                    if (currentChannel.name && currentChannel.url) {
                        currentChannel.id = generateId(currentChannel.url);
                        channels.push({ ...currentChannel });
                    }
                    hasInfo = false;
                }
            }
            return channels;
        }

        function isValidUrlLine(line) {
            // Aceita formatos comuns e o formato "quebrado" da lista
            return line.startsWith('http') || line.startsWith('rtmp') || line.startsWith('://') || (line.endsWith('.ts') && !line.startsWith('#')) || (line.endsWith('.m3u8') && !line.startsWith('#')) || (line.endsWith('.mp4') && !line.startsWith('#'));
        }

        function generateId(url) {
            let hash = 0;
            for (let i = 0; i < url.length; i++) {
                hash = ((hash << 5) - hash) + url.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash).toString(36);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            setLoading(true, "Lendo arquivo...");
            const reader = new FileReader();
            reader.onload = (e) => processPlaylist(e.target.result);
            reader.readAsText(file);
        }

        async function loadFromUrl() {
            let url = document.getElementById('urlInput').value.trim();
            if(!url) return;
            setLoading(true, "Baixando lista...");
            try {
                let response = await fetch(url);
                if (!response.ok) throw new Error('Falha direta');
                let text = await response.text();
                processPlaylist(text);
            } catch (err) {
                setLoading(true, "Tentando Proxy...");
                try {
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    const data = await response.json();
                    if (data.contents) processPlaylist(data.contents);
                    else throw new Error("Vazio");
                } catch (proxyErr) {
                    alert('Erro ao baixar lista. Tente baixar o arquivo .m3u no seu PC.');
                    setLoading(false);
                }
            }
        }

        function processPlaylist(content) {
            setLoading(true, "Processando...");
            setTimeout(() => {
                allChannels = parseM3U(content);
                if (allChannels.length === 0) {
                    alert('Nenhum canal encontrado.');
                    setLoading(false);
                    return;
                }
                allChannels.sort((a, b) => a.name.localeCompare(b.name));
                document.getElementById('setupModal').classList.add('hidden');
                populateGroups();
                updateHomeCounts();
                showHomeScreen(); 
                setLoading(false);
            }, 100);
        }

        function updateHomeCounts() {
            const liveCount = allChannels.filter(c => c.type === 'live').length;
            const moviesCount = allChannels.filter(c => c.type === 'movies').length;
            const seriesCount = allChannels.filter(c => c.type === 'series').length;
            document.getElementById('count-live').textContent = `${liveCount} Canais`;
            document.getElementById('count-movies').textContent = `${moviesCount} T√≠tulos`;
            document.getElementById('count-series').textContent = `${seriesCount} T√≠tulos`;
        }

        function setLoading(active, text = "") {
            const el = document.getElementById('loadingState');
            if (active) {
                el.classList.remove('hidden');
                document.getElementById('loadingText').textContent = text;
            } else {
                el.classList.add('hidden');
            }
        }

        // --- Navega√ß√£o e Views ---

        function showHomeScreen() {
            currentCategory = 'home';
            currentSubCategoryType = null;
            toggleLayout(true);
            
            document.getElementById('homeScreen').classList.remove('hidden');
            document.getElementById('homeScreen').classList.add('flex');
            document.getElementById('subcategoriesView').classList.add('hidden');
            document.getElementById('channelsView').classList.add('hidden');
        }

        function renderSubcategories(type) {
            currentSubCategoryType = type;
            toggleLayout(false); 

            const relevantGroups = [...new Set(allChannels.filter(c => c.type === type).map(c => c.group))].sort();
            const grid = document.getElementById('subcategoriesGrid');
            grid.innerHTML = '';
            const titleMap = { 'live': 'TV Ao Vivo', 'movies': 'Filmes', 'series': 'S√©ries' };
            document.getElementById('subcategoryTitle').textContent = `Categorias de ${titleMap[type] || 'V√≠deo'}`;

            if (relevantGroups.length === 0) grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">Nenhuma categoria encontrada.</p>';

            relevantGroups.forEach(group => {
                const count = allChannels.filter(c => c.group === group && c.type === type).length;
                const card = document.createElement('button');
                card.className = 'bg-dark-800 p-6 rounded-xl border border-dark-700 hover:border-brand-500 hover:bg-dark-700 transition-all text-left group flex flex-col justify-between h-32';
                card.onclick = () => filterByGroup(group);
                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <i class="ph ph-folder text-3xl text-brand-500 group-hover:text-white transition"></i>
                        <span class="text-xs bg-dark-900 text-gray-400 px-2 py-1 rounded-full border border-dark-700">${count}</span>
                    </div>
                    <span class="font-medium text-white truncate w-full" title="${group}">${group}</span>
                `;
                grid.appendChild(card);
            });

            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('homeScreen').classList.remove('flex');
            document.getElementById('subcategoriesView').classList.remove('hidden');
            document.getElementById('channelsView').classList.add('hidden');

            updateSidebarUI(type);
        }

        function goBackToSubcategories() {
            if (currentSubCategoryType) renderSubcategories(currentSubCategoryType);
            else showHomeScreen();
        }

        function renderChannels(channels, append = false) {
            const grid = document.getElementById('contentGrid');
            const empty = document.getElementById('emptyState');
            const loadMoreBtn = document.getElementById('loadMoreContainer');
            const countEl = document.getElementById('channelCount');
            
            if(document.getElementById('mainSidebar').classList.contains('hidden')) toggleLayout(false);

            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('homeScreen').classList.remove('flex');
            document.getElementById('subcategoriesView').classList.add('hidden');
            document.getElementById('channelsView').classList.remove('hidden');

            if (!append) {
                grid.innerHTML = '';
                renderedCount = 0;
                document.getElementById('mainContainer').scrollTop = 0;
            }

            countEl.innerText = `${channels.length} canais`;

            if (channels.length === 0) {
                empty.classList.remove('hidden');
                loadMoreBtn.classList.add('hidden');
                return;
            }
            empty.classList.add('hidden');

            const nextBatch = channels.slice(renderedCount, renderedCount + BATCH_SIZE);
            nextBatch.forEach(channel => {
                const isFav = favorites.includes(channel.id);
                const card = document.createElement('div');
                card.className = 'group relative bg-dark-800 rounded-lg overflow-hidden cursor-pointer card-hover transition-all duration-300 aspect-video flex flex-col border border-dark-700';
                card.onclick = (e) => { if(!e.target.closest('.fav-btn')) openPlayer(channel); };

                let logoUrl = channel.logo;
                if (!logoUrl || logoUrl.length < 5) {
                    const initials = channel.name.substring(0,2).toUpperCase();
                    logoUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=1e293b&color=6366f1&size=256&font-size=0.4&bold=true`;
                }

                card.innerHTML = `
                    <div class="relative flex-1 bg-black w-full overflow-hidden">
                        <img src="${logoUrl}" alt="${channel.name}" loading="lazy" class="w-full h-full object-contain p-2 group-hover:scale-105 transition duration-500 opacity-90 group-hover:opacity-100" onerror="this.src='https://placehold.co/400x225/1e293b/FFF?text=No+Image'">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center backdrop-blur-[2px]">
                            <i class="ph ph-play-circle text-5xl text-brand-500 drop-shadow-xl scale-75 group-hover:scale-100 transition"></i>
                        </div>
                        <button class="fav-btn absolute top-2 right-2 p-2 rounded-full bg-black/60 hover:bg-brand-600 transition z-10 ${isFav ? 'text-red-500' : 'text-gray-300'}" onclick="toggleFavorite('${channel.id}')">
                            <i class="ph ${isFav ? 'ph-heart-fill' : 'ph-heart'} text-lg"></i>
                        </button>
                    </div>
                    <div class="p-3 bg-dark-800 border-t border-dark-700 z-10 relative">
                        <h3 class="font-medium text-sm text-gray-200 truncate pr-4" title="${channel.name}">${channel.name}</h3>
                        <p class="text-[10px] text-brand-500 uppercase font-bold tracking-wider truncate mt-1">${channel.group}</p>
                    </div>
                `;
                grid.appendChild(card);
            });

            renderedCount += nextBatch.length;
            loadMoreBtn.classList.toggle('hidden', renderedCount >= channels.length);
        }

        function loadMoreChannels() { renderChannels(filteredChannels, true); }
        
        function filterCategory(cat) {
            currentCategory = cat;
            if (['live', 'movies', 'series'].includes(cat)) {
                renderSubcategories(cat);
            } else {
                toggleLayout(false); 
                applyFilters();
            }
        }

        function filterByGroup(group) {
            updateSidebarUI(null, group);
            currentCategory = 'group';
            document.getElementById('currentGroupTitle').textContent = group;
            filteredChannels = allChannels.filter(c => c.group === group);
            renderChannels(filteredChannels);
        }

        function populateGroups() {
            const groups = [...new Set(allChannels.map(c => c.group))].sort();
            const groupList = document.getElementById('groupList');
            groupList.innerHTML = '';
            const limit = 20; 
            groups.slice(0, limit).forEach(group => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left px-3 py-2 text-sm text-gray-400 hover:text-white hover:bg-dark-700 rounded truncate transition';
                btn.textContent = group;
                btn.onclick = () => { filterByGroup(group); toggleMobileMenu(); };
                groupList.appendChild(btn);
            });
        }

        function updateSidebarUI(activeId, activeGroup = null) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-brand-600/10', 'text-brand-500');
                el.classList.add('text-gray-400');
            });
            if (activeId === 'home') {
                const homeBtn = document.getElementById('btn-home');
                if(homeBtn) { homeBtn.classList.remove('text-gray-400'); homeBtn.classList.add('bg-brand-600/10', 'text-brand-500'); }
                return;
            }
            if (activeId) {
                const btn = document.querySelector(`button[onclick="filterCategory('${activeId}')"]`);
                if(btn) { btn.classList.remove('text-gray-400'); btn.classList.add('bg-brand-600/10', 'text-brand-500'); }
            }
            Array.from(document.getElementById('groupList').children).forEach(btn => {
                if(btn.textContent === activeGroup) { btn.classList.add('text-brand-500', 'font-bold'); btn.classList.remove('text-gray-400'); }
                else { btn.classList.remove('text-brand-500', 'font-bold'); btn.classList.add('text-gray-400'); }
            });
            const title = activeGroup || (activeId === 'all' ? 'Todos' : activeId === 'favorites' ? 'Favoritos' : activeId);
            document.getElementById('categoryTitle').textContent = title;
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            if (currentCategory === 'home' && query.length > 0) {
                 filterCategory('all');
            }
            applyFilters(query);
        }

        function applyFilters(searchQuery = '') {
            let list = allChannels;
            if (currentCategory === 'favorites') list = list.filter(c => favorites.includes(c.id));
            else if (['live', 'movies', 'series'].includes(currentCategory)) list = list.filter(c => c.type === currentCategory);
            const query = searchQuery || document.getElementById('searchInput').value.toLowerCase();
            if (query) list = list.filter(c => c.name.toLowerCase().includes(query) || c.group.toLowerCase().includes(query));
            filteredChannels = list;
            renderChannels(list);
        }

        function toggleFavorite(id) {
            favorites = favorites.includes(id) ? favorites.filter(fav => fav !== id) : [...favorites, id];
            localStorage.setItem('streamflow_favorites', JSON.stringify(favorites));
            const btn = document.querySelector(`button[onclick="toggleFavorite('${id}')"]`);
            if(btn) {
                 const isFav = favorites.includes(id);
                 btn.innerHTML = `<i class="ph ${isFav ? 'ph-heart-fill' : 'ph-heart'} text-lg"></i>`;
                 btn.classList.toggle('text-red-500', isFav);
                 btn.classList.toggle('text-gray-300', !isFav);
            }
            if(currentCategory === 'favorites') applyFilters();
        }

        function toggleMobileMenu() { document.getElementById('mobileMenu').classList.add('hidden'); }

        // --- Player ---
        function openPlayer(channel) {
            document.getElementById('playerOverlay').classList.remove('hidden');
            document.getElementById('playerError').classList.add('hidden');
            document.getElementById('playerTitle').textContent = channel.name;
            document.getElementById('playerGroup').textContent = channel.group;

            let playUrl = channel.url;
            
            // Detectar bloqueio de mixed content
            if (window.location.protocol === 'https:' && playUrl.startsWith('http:')) {
                // N√£o impede de tentar, mas j√° prepara para erro
                console.warn('Tentando reproduzir HTTP em HTTPS. Pode ser bloqueado.');
            }

            // Convers√£o HLS apenas se for .ts
            if (playUrl.includes('.ts')) {
                playUrl = playUrl.replace('.ts', '.m3u8');
            }
            // OBS: Se for .mp4, initVideo j√° vai tratar corretamente abaixo
            
            initVideo(playUrl);
        }

        function initVideo(url) {
            // DETEC√á√ÉO INTELIGENTE DE FORMATO (MP4 vs HLS)
            const isMP4 = url.toLowerCase().includes('.mp4') || url.toLowerCase().includes('.mkv');
            
            if (isMP4) {
                 console.log("Reproduzindo MP4/MKV nativo:", url);
                 if(hls) { hls.destroy(); hls = null; }
                 video.src = url;
                 video.play().catch(e => console.error("Erro autoplay MP4:", e));
                 return;
            }

            // Se n√£o for MP4, tenta HLS
            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
                hls.on(Hls.Events.ERROR, (e, data) => {
                    if (data.fatal) {
                        if(data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                             console.log("Erro de rede, poss√≠vel bloqueio ou CORS");
                             hls.startLoad();
                        } else {
                             handleVideoError();
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.play();
            }
        }

        function closePlayer() {
            document.getElementById('playerOverlay').classList.add('hidden');
            video.pause();
            video.src = '';
            document.getElementById('loadingOverlay').classList.add('hidden');
            clearTimeout(loadTimeout);
            if(hls) { hls.destroy(); hls = null; }
        }

        function handleVideoError() { 
            document.getElementById('playerError').classList.remove('hidden'); 
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function retryStream() { 
            document.getElementById('playerError').classList.add('hidden'); 
            document.getElementById('loadingOverlay').classList.remove('hidden');
            if(hls && hls.url) { hls.loadSource(hls.url); hls.attachMedia(video); }
            else if (video.src) { video.load(); video.play(); }
        }
        function toggleAspectRatio() { video.style.objectFit = video.style.objectFit === 'cover' ? 'contain' : 'cover'; }
        
        function switchTab(t){
             ['file','url'].forEach(x=>document.getElementById(`tab-${x}`).className=`flex-1 pb-4 font-medium transition ${x===t?'text-brand-500 border-b-2 border-brand-500':'text-gray-400'}`);
             ['file','url'].forEach(x=>document.getElementById(`content-${x}`).classList.toggle('hidden', x!==t));
        }
    </script>
</body>
</html>
