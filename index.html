<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayerFLOW - Web IPTV Player</title>
    <meta name="description" content="Reprodutor IPTV Web Profissional com sistema de múltiplos proxies.">
    <meta name="theme-color" content="#0f172a">
    <meta name="referrer" content="no-referrer">

    <!-- Bibliotecas Essenciais -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Configuração Visual -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#6366f1', 600: '#4f46e5' }, // Indigo
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' } // Slate
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(5px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: #f1f5f9; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #6366f1; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        video:focus { outline: none; }
    </style>
</head>
<body class="font-sans antialiased overflow-hidden h-screen flex flex-col selection:bg-brand-500 selection:text-white">

    <!-- 1. TELA DE SETUP (Drag & Drop) -->
    <div id="setupScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-dark-900 p-4">
        <div class="max-w-md w-full bg-dark-800 rounded-2xl shadow-2xl border border-dark-700 p-8 text-center animate-fade-in">
            <div class="w-16 h-16 bg-brand-500/10 rounded-full flex items-center justify-center mx-auto mb-6 text-brand-500">
                <i class="ph ph-play-circle text-4xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">PlayerFLOW</h1>
            <p class="text-gray-400 text-sm mb-8">Arraste seu arquivo .M3U aqui para começar.</p>
            
            <label class="block w-full border-2 border-dashed border-dark-700 hover:border-brand-500 hover:bg-dark-700/50 rounded-xl p-8 cursor-pointer transition-all group">
                <div class="flex flex-col items-center">
                    <i class="ph ph-upload-simple text-3xl text-gray-500 group-hover:text-white mb-2 transition-colors"></i>
                    <span class="text-sm font-medium text-gray-400 group-hover:text-white">Selecionar Arquivo</span>
                </div>
                <input id="fileInput" type="file" class="hidden" accept=".m3u,.m3u8,.txt">
            </label>

            <div id="setupLoader" class="hidden mt-6">
                <div class="loader w-8 h-8 border-2"></div>
                <p class="text-xs text-gray-500 mt-2">Processando canais...</p>
            </div>
        </div>
    </div>

    <!-- 2. LAYOUT PRINCIPAL -->
    <div id="appLayout" class="hidden h-full flex flex-col lg:flex-row">
        
        <!-- Sidebar -->
        <aside class="w-full lg:w-72 bg-dark-800 border-r border-dark-700 flex flex-col z-20 shrink-0">
            <div class="h-16 flex items-center px-6 border-b border-dark-700">
                <i class="ph ph-waves text-brand-500 text-2xl mr-3"></i>
                <span class="font-bold text-lg tracking-tight">PlayerFLOW</span>
            </div>

            <nav class="flex-1 overflow-y-auto p-4 space-y-1">
                <button onclick="navTo('home')" class="nav-btn w-full flex items-center p-3 rounded-lg text-sm font-medium bg-brand-600/10 text-brand-500 transition-colors">
                    <i class="ph ph-house text-lg mr-3"></i> Início
                </button>
                <div class="pt-4 pb-2 px-3 text-xs font-bold text-gray-500 uppercase tracking-wider">Biblioteca</div>
                <button onclick="navTo('live')" class="nav-btn w-full flex items-center p-3 rounded-lg text-sm font-medium text-gray-400 hover:text-white hover:bg-dark-700 transition-colors">
                    <i class="ph ph-television text-lg mr-3"></i> TV Ao Vivo
                </button>
                <button onclick="navTo('movies')" class="nav-btn w-full flex items-center p-3 rounded-lg text-sm font-medium text-gray-400 hover:text-white hover:bg-dark-700 transition-colors">
                    <i class="ph ph-film-strip text-lg mr-3"></i> Filmes
                </button>
                <button onclick="navTo('series')" class="nav-btn w-full flex items-center p-3 rounded-lg text-sm font-medium text-gray-400 hover:text-white hover:bg-dark-700 transition-colors">
                    <i class="ph ph-cards text-lg mr-3"></i> Séries
                </button>
                <button onclick="navTo('favorites')" class="nav-btn w-full flex items-center p-3 rounded-lg text-sm font-medium text-gray-400 hover:text-white hover:bg-dark-700 transition-colors">
                    <i class="ph ph-heart text-lg mr-3"></i> Favoritos
                </button>
            </nav>

            <div class="p-4 border-t border-dark-700">
                <button onclick="location.reload()" class="flex items-center text-xs text-red-400 hover:text-red-300 transition-colors">
                    <i class="ph ph-sign-out text-lg mr-2"></i> Sair / Trocar Lista
                </button>
            </div>
        </aside>

        <!-- Área de Conteúdo -->
        <main class="flex-1 flex flex-col relative bg-dark-900 min-w-0">
            <header class="h-16 border-b border-dark-700 flex items-center justify-between px-6 bg-dark-900/50 backdrop-blur-md sticky top-0 z-10">
                <div class="relative w-full max-w-md">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    <input id="searchInput" type="text" placeholder="Buscar canal, filme ou série..." 
                           class="w-full bg-dark-800 border border-dark-700 rounded-full pl-10 pr-4 py-2 text-sm text-white focus:outline-none focus:border-brand-500 transition-colors">
                </div>
                <div class="hidden sm:block text-right">
                    <div id="headerTitle" class="text-sm font-bold text-white">Início</div>
                    <div id="headerCount" class="text-xs text-gray-500">0 itens</div>
                </div>
            </header>

            <div id="mainScroll" class="flex-1 overflow-y-auto p-6 custom-scroll">
                <!-- VIEW 1: HOME DASHBOARD -->
                <div id="viewHome" class="max-w-5xl mx-auto py-8 animate-fade-in">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold text-white mb-2">Bem-vindo</h2>
                        <p class="text-gray-400">Selecione uma categoria para assistir.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div onclick="navTo('live')" class="group cursor-pointer bg-gradient-to-br from-dark-800 to-dark-800 hover:from-blue-900/20 hover:to-dark-800 border border-dark-700 hover:border-blue-500/50 rounded-2xl p-8 text-center transition-all duration-300 hover:-translate-y-1 shadow-lg">
                            <div class="w-16 h-16 bg-dark-900 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500 group-hover:scale-110 transition-transform">
                                <i class="ph ph-television text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">TV Ao Vivo</h3>
                            <p id="countLive" class="text-sm text-gray-500">0 Canais</p>
                        </div>
                        <div onclick="navTo('movies')" class="group cursor-pointer bg-gradient-to-br from-dark-800 to-dark-800 hover:from-purple-900/20 hover:to-dark-800 border border-dark-700 hover:border-purple-500/50 rounded-2xl p-8 text-center transition-all duration-300 hover:-translate-y-1 shadow-lg">
                            <div class="w-16 h-16 bg-dark-900 rounded-full flex items-center justify-center mx-auto mb-4 text-purple-500 group-hover:scale-110 transition-transform">
                                <i class="ph ph-film-strip text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">Filmes</h3>
                            <p id="countMovies" class="text-sm text-gray-500">0 Títulos</p>
                        </div>
                        <div onclick="navTo('series')" class="group cursor-pointer bg-gradient-to-br from-dark-800 to-dark-800 hover:from-emerald-900/20 hover:to-dark-800 border border-dark-700 hover:border-emerald-500/50 rounded-2xl p-8 text-center transition-all duration-300 hover:-translate-y-1 shadow-lg">
                            <div class="w-16 h-16 bg-dark-900 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-500 group-hover:scale-110 transition-transform">
                                <i class="ph ph-cards text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">Séries</h3>
                            <p id="countSeries" class="text-sm text-gray-500">0 Títulos</p>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: CATEGORIAS -->
                <div id="viewCategories" class="hidden animate-fade-in">
                    <div class="flex items-center mb-6 gap-3">
                        <button onclick="navTo('home')" class="p-2 hover:bg-dark-700 rounded-full text-gray-400 hover:text-white transition"><i class="ph ph-arrow-left text-xl"></i></button>
                        <h2 id="catTitle" class="text-2xl font-bold text-white">Categorias</h2>
                    </div>
                    <div id="gridCategories" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>

                <!-- VIEW 3: ITENS -->
                <div id="viewItems" class="hidden animate-fade-in">
                    <div class="flex items-center mb-6 gap-3">
                        <button onclick="backToCat()" class="p-2 hover:bg-dark-700 rounded-full text-gray-400 hover:text-white transition"><i class="ph ph-arrow-left text-xl"></i></button>
                        <h2 id="groupTitle" class="text-xl font-bold text-white truncate">Nome do Grupo</h2>
                    </div>
                    <div id="gridItems" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
                    <div id="loadMore" class="hidden text-center py-8">
                        <button onclick="renderGrid(true)" class="px-6 py-2 bg-dark-800 hover:bg-dark-700 text-white rounded-full text-sm font-medium transition">Carregar Mais</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 3. PLAYER OVERLAY -->
    <div id="playerOverlay" class="fixed inset-0 z-50 bg-black hidden flex-col">
        <div class="absolute top-0 left-0 right-0 p-6 bg-gradient-to-b from-black/80 to-transparent z-20 flex justify-between items-start opacity-0 hover:opacity-100 transition-opacity duration-300">
            <div class="flex items-center gap-4">
                <button onclick="closePlayer()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-md text-white transition">
                    <i class="ph ph-x text-xl"></i>
                </button>
                <div>
                    <h2 id="playerTitle" class="text-white font-bold text-lg leading-tight drop-shadow-md">Título</h2>
                    <div class="flex items-center gap-2">
                        <span id="playerTag" class="text-[10px] uppercase font-bold px-2 py-0.5 rounded bg-brand-600 text-white">LIVE</span>
                        <p id="playerSub" class="text-gray-300 text-xs drop-shadow-md">Info</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 relative flex items-center justify-center bg-black">
            <video id="mainVideo" class="w-full h-full max-h-screen" controls autoplay playsinline crossorigin="anonymous"></video>
            
            <div id="playerLoader" class="absolute inset-0 flex items-center justify-center pointer-events-none hidden">
                <div class="flex flex-col items-center">
                    <div class="loader border-brand-500"></div>
                    <p id="proxyStatus" class="text-xs text-gray-400 mt-2 animate-pulse">Conectando...</p>
                </div>
            </div>

            <div id="playerError" class="absolute inset-0 z-30 bg-black/95 flex items-center justify-center p-6 hidden">
                <div class="max-w-md w-full bg-dark-800 border border-dark-700 rounded-2xl p-6 text-center">
                    <div class="w-14 h-14 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                        <i class="ph ph-warning-octagon text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2">Erro de Reprodução</h3>
                    <p class="text-sm text-gray-400 mb-6">Não foi possível carregar este canal com nenhum dos métodos seguros disponíveis.</p>
                    <button onclick="closePlayer()" class="px-4 py-2 rounded-lg border border-dark-600 text-gray-300 hover:text-white text-sm">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CORE LOGIC -->
    <script>
        // --- PROXY ROTATION SYSTEM ---
        const PROXY_URLS = [
            url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            url => url // Tentativa direta (para casos raros ou localhost)
        ];

        const state = {
            channels: [],
            filtered: [],
            favorites: JSON.parse(localStorage.getItem('pflow_favs') || '[]'),
            view: 'home',
            subType: null,
            currentGroup: null,
            page: 0,
            batch: 50,
            proxyIndex: 0,
            currentChannelId: null
        };

        const els = {
            setup: document.getElementById('setupScreen'),
            app: document.getElementById('appLayout'),
            loader: document.getElementById('setupLoader'),
            video: document.getElementById('mainVideo'),
            pLoader: document.getElementById('playerLoader'),
            pError: document.getElementById('playerError'),
            pStatus: document.getElementById('proxyStatus')
        };

        let hls = null;

        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.querySelector('label');
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('border-brand-500'); });
            dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('border-brand-500'); });
            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.classList.remove('border-brand-500');
                if(e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
            });
            document.getElementById('fileInput').addEventListener('change', e => {
                if(e.target.files.length) loadFile(e.target.files[0]);
            });
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));

            els.video.addEventListener('waiting', () => els.pLoader.classList.remove('hidden'));
            els.video.addEventListener('playing', () => els.pLoader.classList.add('hidden'));
            els.video.addEventListener('error', () => handleVideoError());
        });

        // --- Parser Corrigido ---
        function loadFile(file) {
            els.loader.classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = e => parseContent(e.target.result);
            reader.readAsText(file);
        }

        function parseContent(text) {
            const lines = text.split(/\r?\n/);
            const data = [];
            let current = null;

            for(let line of lines) {
                line = line.trim();
                if(!line) continue;

                if(line.startsWith('#EXTINF:')) {
                    const meta = line.substring(8);
                    const nameParts = meta.split(',');
                    const name = nameParts[nameParts.length-1].trim();
                    const logo = (meta.match(/tvg-logo="([^"]*)"/) || [])[1] || '';
                    let group = (meta.match(/group-title="([^"]*)"/) || [])[1] || 'Outros';
                    
                    current = { name, logo, group, id: '' };
                    
                    const gLow = group.toLowerCase();
                    if(gLow.includes('movie') || gLow.includes('filme')) current.type = 'movies';
                    else if(gLow.includes('series') || gLow.includes('serie')) current.type = 'series';
                    else current.type = 'live';

                } else if(line.startsWith('http') || line.startsWith('rtmp') || line.startsWith('://')) {
                    if(current) {
                        let url = line;
                        if(url.startsWith('://')) {
                            let clean = url.substring(3).replace(':/', '/');
                            url = 'http://' + clean;
                        }
                        current.url = url;
                        current.id = btoa(url).slice(0, 12);
                        data.push(current);
                        current = null;
                    }
                }
            }

            if(data.length === 0) {
                alert("Nenhum canal encontrado.");
                els.loader.classList.add('hidden');
                return;
            }

            state.channels = data.sort((a,b) => a.name.localeCompare(b.name));
            els.setup.classList.add('hidden');
            els.app.classList.remove('hidden');
            els.app.classList.add('flex');
            updateHomeCounts();
            navTo('home');
        }

        // --- Navegação ---
        function navTo(target) {
            state.view = target;
            document.querySelectorAll('.nav-btn').forEach(b => b.className = 'nav-btn w-full flex items-center p-3 rounded-lg text-sm font-medium text-gray-400 hover:text-white hover:bg-dark-700 transition-colors');
            const activeBtn = document.querySelector(`button[onclick="navTo('${target}')"]`);
            if(activeBtn) activeBtn.className = 'nav-btn w-full flex items-center p-3 rounded-lg text-sm font-medium bg-brand-600/10 text-brand-500 transition-colors';

            document.getElementById('viewHome').classList.add('hidden');
            document.getElementById('viewCategories').classList.add('hidden');
            document.getElementById('viewItems').classList.add('hidden');

            if(target === 'home') {
                document.getElementById('viewHome').classList.remove('hidden');
                updateHeader('Início', state.channels.length + ' itens');
            } else if(['live', 'movies', 'series'].includes(target)) {
                state.subType = target;
                renderCategories(target);
            } else if(target === 'favorites') {
                state.subType = 'favorites';
                renderFavorites();
            }
        }

        function renderCategories(type) {
            document.getElementById('viewCategories').classList.remove('hidden');
            const grid = document.getElementById('gridCategories');
            grid.innerHTML = '';
            const groups = [...new Set(state.channels.filter(c => c.type === type).map(c => c.group))].sort();
            const titles = { 'live': 'TV Ao Vivo', 'movies': 'Filmes', 'series': 'Séries' };
            document.getElementById('catTitle').innerText = titles[type];
            updateHeader(titles[type], groups.length + ' Categorias');

            groups.forEach(g => {
                const count = state.channels.filter(c => c.group === g && c.type === type).length;
                const el = document.createElement('div');
                el.className = 'bg-dark-800 p-4 rounded-xl border border-dark-700 hover:border-brand-500 cursor-pointer transition-all hover:bg-dark-700';
                el.onclick = () => openGroup(g);
                el.innerHTML = `<div class="flex justify-between items-center mb-2"><i class="ph ph-folder-simple text-2xl text-brand-500"></i><span class="text-xs font-bold bg-dark-900 px-2 py-1 rounded text-gray-400">${count}</span></div><div class="font-medium text-white truncate">${g}</div>`;
                grid.appendChild(el);
            });
        }

        function openGroup(group) {
            state.currentGroup = group;
            state.filtered = state.channels.filter(c => c.group === group && c.type === state.subType);
            state.page = 0;
            document.getElementById('viewCategories').classList.add('hidden');
            document.getElementById('viewItems').classList.remove('hidden');
            document.getElementById('groupTitle').innerText = group;
            document.getElementById('gridItems').innerHTML = '';
            renderGrid();
        }

        function renderFavorites() {
            state.filtered = state.channels.filter(c => state.favorites.includes(c.id));
            state.page = 0;
            state.currentGroup = 'Favoritos';
            document.getElementById('viewItems').classList.remove('hidden');
            document.getElementById('groupTitle').innerText = 'Meus Favoritos';
            document.getElementById('gridItems').innerHTML = '';
            renderGrid();
        }

        function renderGrid(append = false) {
            const grid = document.getElementById('gridItems');
            const start = state.page * state.batch;
            const end = start + state.batch;
            const items = state.filtered.slice(start, end);
            
            items.forEach(c => {
                const isFav = state.favorites.includes(c.id);
                let img = c.logo && c.logo.length > 5 ? c.logo : `https://ui-avatars.com/api/?name=${encodeURI(c.name)}&background=1e293b&color=fff&size=128`;
                const el = document.createElement('div');
                el.className = 'group relative bg-dark-800 rounded-lg overflow-hidden border border-dark-700 hover:border-brand-500 transition-all';
                el.innerHTML = `
                    <div class="aspect-video bg-black relative cursor-pointer" onclick="playChannel('${c.id}')">
                        <img src="${img}" class="w-full h-full object-contain p-2 opacity-80 group-hover:opacity-100 transition-opacity" loading="lazy" onerror="this.src='https://placehold.co/300x200/1e293b/FFF?text=No+Image'">
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/40"><i class="ph ph-play-circle text-4xl text-brand-500 drop-shadow-xl"></i></div>
                    </div>
                    <div class="p-3">
                        <div class="font-medium text-sm text-gray-200 truncate" title="${c.name}">${c.name}</div>
                        <button onclick="toggleFav('${c.id}', this)" class="absolute top-2 right-2 p-1.5 rounded-full bg-black/60 text-white hover:text-red-500 transition z-10 ${isFav ? 'text-red-500' : ''}"><i class="ph ${isFav ? 'ph-heart-fill' : 'ph-heart'} text-lg"></i></button>
                    </div>
                `;
                grid.appendChild(el);
            });

            state.page++;
            const btn = document.getElementById('loadMore');
            if(state.filtered.length > end) btn.classList.remove('hidden'); else btn.classList.add('hidden');
        }

        function backToCat() {
            if(state.subType === 'favorites') navTo('home');
            else renderCategories(state.subType);
        }

        function handleSearch(e) {
            const q = e.target.value.toLowerCase();
            if(!q) return state.view === 'items' && renderGrid();
            document.getElementById('viewHome').classList.add('hidden');
            document.getElementById('viewCategories').classList.add('hidden');
            document.getElementById('viewItems').classList.remove('hidden');
            state.filtered = state.channels.filter(c => c.name.toLowerCase().includes(q));
            state.page = 0;
            state.currentGroup = 'Busca';
            document.getElementById('groupTitle').innerText = `Resultados para "${q}"`;
            document.getElementById('gridItems').innerHTML = '';
            renderGrid();
        }

        function toggleFav(id, btn) {
            const idx = state.favorites.indexOf(id);
            if(idx > -1) { state.favorites.splice(idx, 1); btn.classList.remove('text-red-500'); } 
            else { state.favorites.push(id); btn.classList.add('text-red-500'); }
            localStorage.setItem('pflow_favs', JSON.stringify(state.favorites));
            if(state.subType === 'favorites') renderFavorites();
        }

        function updateHomeCounts() {
            document.getElementById('countLive').innerText = state.channels.filter(c=>c.type==='live').length + ' Canais';
            document.getElementById('countMovies').innerText = state.channels.filter(c=>c.type==='movies').length + ' Títulos';
            document.getElementById('countSeries').innerText = state.channels.filter(c=>c.type==='series').length + ' Títulos';
        }

        function updateHeader(title, sub) {
            document.getElementById('headerTitle').innerText = title;
            document.getElementById('headerCount').innerText = sub;
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        // --- PLAYER ENGINE COM ROTAÇÃO DE PROXY ---
        
        function playChannel(id) {
            const item = state.channels.find(c => c.id === id);
            if(!item) return;

            state.currentChannelId = id;
            state.proxyIndex = 0; // Reinicia proxy para o primeiro

            document.getElementById('playerOverlay').classList.remove('hidden');
            document.getElementById('playerOverlay').classList.add('flex');
            document.getElementById('playerTitle').innerText = item.name;
            document.getElementById('playerSub').innerText = item.group;
            document.getElementById('playerTag').innerText = item.type === 'live' ? 'LIVE' : 'VOD';
            document.getElementById('playerTag').className = `text-[10px] uppercase font-bold px-2 py-0.5 rounded text-white ${item.type === 'live' ? 'bg-red-600' : 'bg-blue-600'}`;
            
            els.pError.classList.add('hidden');
            els.pLoader.classList.remove('hidden');

            let url = item.url;
            if(url.includes('.ts')) url = url.replace('.ts', '.m3u8');
            
            initVideo(url);
        }

        function initVideo(url) {
            // Se falhou todos os proxies, mostra erro
            if (state.proxyIndex >= PROXY_URLS.length) {
                els.pLoader.classList.add('hidden');
                els.pError.classList.remove('hidden');
                return;
            }

            // Define URL com Proxy
            const proxyFn = PROXY_URLS[state.proxyIndex];
            // Se for MP4, aplica proxy no link. Se for HLS, aplica via xhrSetup
            const isMP4 = url.toLowerCase().match(/\.(mp4|mkv)(\?.*)?$/i);
            
            els.pStatus.innerText = state.proxyIndex > 0 ? `Tentando rota alternativa ${state.proxyIndex}...` : "Conectando...";

            if (isMP4) {
                if(hls) { hls.destroy(); hls = null; }
                const proxiedUrl = proxyFn(url);
                els.video.src = proxiedUrl;
                els.video.play().catch(e => console.log("Autoplay:", e));
            } else if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                    // Intercepta TODOS os fragmentos (.ts) e aplica o proxy atual
                    xhrSetup: function(xhr, u) {
                        // Só aplica proxy se a URL for http/https (evita blob:)
                        if (u.startsWith('http')) {
                            // Se já estamos usando um proxy, a URL 'u' pode já estar proxeada se for relativa?
                            // O HLS.js resolve URLs. Se for rota 0 (direta), não faz nada.
                            // Se for rota > 0 (proxy), envelopa.
                            if (state.proxyIndex > 0 || u.startsWith('http:')) { 
                                // Nota: mesmo na rota 0, se for http em https, vai falhar sem proxy.
                                // Mas PROXY_URLS[0] é um proxy. PROXY_URLS[2] é direto.
                                // Vamos aplicar sempre a função de proxy atual.
                                const targetUrl = proxyFn(u);
                                // Evita duplo proxy se a URL já estiver proxeada (verificação simples)
                                if (!u.includes('corsproxy.io') && !u.includes('allorigins')) {
                                    xhr.open('GET', targetUrl);
                                }
                            }
                        }
                    }
                });
                
                // Para carregar a playlist inicial, usamos o proxy também
                const masterUrl = proxyFn(url);
                hls.loadSource(masterUrl);
                hls.attachMedia(els.video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => els.video.play());
                
                // Se der erro de rede, tenta o próximo proxy
                hls.on(Hls.Events.ERROR, (e, data) => {
                    if (data.fatal && data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                        console.log("Erro de rede com proxy " + state.proxyIndex);
                        hls.destroy();
                        handleVideoError(); // Chama rotação
                    }
                });
            } else if (els.video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari
                els.video.src = proxyFn(url);
                els.video.play();
            }
        }

        function handleVideoError() {
            // Tenta o próximo proxy
            state.proxyIndex++;
            console.log("Alternando para proxy " + state.proxyIndex);
            
            // Recarrega o canal atual com o novo índice
            const item = state.channels.find(c => c.id === state.currentChannelId);
            if(item) {
                let url = item.url;
                if(url.includes('.ts')) url = url.replace('.ts', '.m3u8');
                initVideo(url);
            }
        }

        function closePlayer() {
            document.getElementById('playerOverlay').classList.add('hidden');
            document.getElementById('playerOverlay').classList.remove('flex');
            els.video.pause();
            els.video.src = '';
            if(hls) { hls.destroy(); hls = null; }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }
    </script>
</body>
</html>
